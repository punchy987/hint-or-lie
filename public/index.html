<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hint or Lie Â· by Mits</title>
  <!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<link rel="stylesheet" href="/style.css">
<meta name="theme-color" content="#0f0b14">
<link rel="apple-touch-icon" href="/icons/icon-180.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="apple-touch-icon" href="/icons/icon-192.png">



<style>
/* =========================
   ThÃ¨me HL (logo) â€” sombre
   ========================= */
:root{
  color-scheme: dark;

  /* Fond + texte */
  --bg:#0f0b14;           /* fond global */
  --card:#17121f;         /* panneaux/verre */
  --line:#2a2135;         /* bordures */
  --ink:#fff7f1;          /* texte principal */
  --text:#fff7f1;         /* alias */
  --muted:#ccb6d9;        /* texte secondaire */

  /* Accents â€” alignÃ©s au logo */
  --accent:#FFA84D;       /* ORANGE neutre (CTA, onglets actifs, highlight) */
  --accent-2:#FF3B3B;     /* ROUGE imposteur / dÃ©faite */
  --accent-3:#7CFF4E;     /* VERT Ã©quipier / succÃ¨s */

  /* Effets */
  --shadow: rgba(0,0,0,.35);
  --glow: 0 0 40px rgba(255,122,89,.18);
}

/* ===== Fond ===== */
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";
  background:
    radial-gradient(1200px 800px at 20% -10%, rgba(255,122,89,.08), transparent 60%),
    radial-gradient(1200px 800px at 120% 10%, rgba(226,78,207,.08), transparent 60%),
    var(--bg);
  overflow-y:auto;
}
.stars::before,.stars::after{
  content:""; position:fixed; inset:-20% -10% -10% -10%; pointer-events:none; z-index:-1;
  background-image: radial-gradient(#ffffff66 1px, transparent 1px);
  background-size:3px 3px; opacity:.10; filter:drop-shadow(0 0 2px #ffffff33);
  animation: drift 160s linear infinite;
}
.stars::after{ opacity:.08; background-size:2px 2px; animation-duration:220s; }
@keyframes drift{ from{transform:translateY(0)} to{transform:translateY(200px)} }

/* ===== Layout ===== */
.wrap{max-width:880px;margin:0 auto;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.muted{color:var(--muted)}
h1,h2,h3,h4{margin:0 0 8px}

/* ===== Cards (verre) ===== */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
  border:1px solid rgba(255,255,255,.10);
  border-radius:20px; padding:16px;
  box-shadow:0 24px 60px rgba(0,0,0,.40), var(--glow);
}
.card.glow{ box-shadow:0 18px 45px color-mix(in srgb, var(--accent) 35%, transparent); }

/* ===== CTA / boutons ===== */
button,.btn-cta{
  width:100%; padding:14px 18px; border-radius:14px; border:0; cursor:pointer;
  font-weight:900; letter-spacing:.3px;
  background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%));
  color:#2a0e16;
  box-shadow:0 12px 28px color-mix(in srgb, var(--accent) 35%, transparent);
  transition: transform .06s ease, filter .2s ease;
}
button:hover,.btn-cta:hover{ filter:brightness(1.06); }
button:active,.btn-cta:active{ transform:translateY(1px); }

/* Secondaires */
.btn-secondary{
  background:#0f1523; color:var(--text);
  border:1px solid var(--line); font-weight:700; border-radius:14px; padding:12px 14px;
}

/* ===== Inputs ===== */
.input, input{
  width:100%; padding:14px; font-size:16px;
  border-radius:14px; outline:none; transition:.2s;
  border:1px solid rgba(255,255,255,.12);
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  color:var(--text);
}
.input::placeholder, input::placeholder{ color:#bfa8c7 }
.input:focus, input:focus{
  border-color: color-mix(in srgb, var(--accent) 60%, white 0%);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent);
}

/* ===== Pills / rÃ´les ===== */
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;display:inline-block}
.role{font-weight:900;border:1px solid currentColor;border-radius:999px;padding:6px 12px;display:inline-block}
.role.crew{color:var(--accent-3); border-color:var(--accent-3)} /* vert */
.role.imp {color:var(--accent-2); border-color:var(--accent-2)} /* rouge */
.section-title{font-size:18px;margin:6px 0}
.hint-word{font-size:34px;font-weight:900;letter-spacing:.3px;margin:4px 0 8px}

/* ===== Hero ===== */
.hero{
  display:flex; gap:16px; align-items:center; padding:16px 14px; border-radius:18px;
  background:linear-gradient(180deg, #1b1422, #14101b);
  border:1px solid var(--line); box-shadow: inset 0 0 0 1px #21162b;
}
.hero h1{font-size:28px; letter-spacing:.3px}
.hero svg{width:62px;height:62px; flex:0 0 62px; filter: drop-shadow(0 8px 18px rgba(255,122,89,.25));}

/* ===== Tabs (home) ===== */
.tabs{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:#140f1a}
.tab-nav{display:flex}
.tab-btn{flex:1;padding:12px 14px;border:0;background:transparent;color:#d9c1e3;font-weight:700;cursor:pointer}
.tab-btn[aria-selected="true"]{
  color:#2a0e16;
  background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%));
  border-radius:12px; margin:6px;
  box-shadow:0 6px 16px rgba(255,122,89,.25);
}
.tab-pane{display:none;padding:14px}
.tab-pane.active{display:block}

/* ===== Scoreboard ===== */
#scoreboard{
  max-width:880px;margin:16px auto 24px;background:#140f1a;
  border:1px solid var(--line);border-radius:16px;padding:12px;display:none;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
#scoreboard ul{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:1fr auto;row-gap:6px}
#scoreboard li{display:contents}
#scoreboard li span:last-child{justify-self:end;color:var(--muted)}
#scoreboard li span:first-child{font-weight:700}

/* ===== Modal result ===== */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
#modal .box{background:#140f1a;border:1px solid var(--line);border-radius:16px;padding:16px;max-width:360px}
.result-banner{border:1px solid; border-radius:10px; padding:8px 12px; display:inline-block; margin:6px 0; font-weight:800; background:#140f1a}
.result-win{color:var(--accent-3);border-color: color-mix(in srgb,var(--accent-3) 80%, transparent); box-shadow:0 0 20px rgba(34,197,94,.25)}
.result-lose{color:var(--accent-2);border-color: color-mix(in srgb,var(--accent-2) 80%, transparent); box-shadow:0 0 20px rgba(244,63,94,.25)}

/* ===== RÃ¨gles / votes ===== */
.rules{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:12px;background:#140f1a}
.grid-votes{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}

#hints p{ padding:8px 10px; border-radius:10px; background:#140f1a; border:1px solid var(--line); }
#vote-buttons button{
  position:relative; padding-right:36px; text-align:left;
  background:#140f1a; border:1px solid var(--line);
}
#vote-buttons button.selected{
  outline:2px solid var(--accent);
  box-shadow:0 0 14px color-mix(in srgb, var(--accent) 35%, transparent);
}
#vote-buttons button.selected::after{
  content:'âœ“'; position:absolute; right:12px; top:50%; transform:translateY(-50%); font-weight:900;
}

/* ===== Barre de phase ===== */
.phase-bar{
  display:grid; grid-template-columns:1fr minmax(320px,1.6fr) 1fr;
  align-items:center; gap:12px; border:1px solid var(--line);
  border-radius:12px; padding:10px 12px; margin-bottom:10px;
  background:linear-gradient(180deg, #1b1422, #14101b);
  box-shadow: inset 0 0 0 1px #21162b, 0 10px 26px rgba(0,0,0,.35);
  position:relative; overflow:hidden;
}
.phase-left{ display:flex; align-items:center; gap:8px; }
.phase-center{ display:flex; justify-content:center; }
.phase-right{ display:flex; justify-content:flex-end; gap:10px; }

/* remplissage animÃ© (pilotÃ© par JS avec --progress 0â†’1) */
.phase-bar::after{
  content:""; position:absolute; inset:0; transform-origin:left center;
  transform: scaleX(var(--progress, 0));
  background: linear-gradient(90deg, rgba(255,168,77,.25), rgba(255,59,59,.25)); /* orange â†’ rouge */
  mix-blend-mode: screen; pointer-events:none; transition:none;
}

.theme-chip{
  display:flex; align-items:center; gap:8px; padding:6px 14px; border-radius:999px;
  border:1px solid color-mix(in srgb, var(--accent) 70%, #fff 0%);
  background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 18%, transparent), color-mix(in srgb, var(--accent-2) 14%, transparent));
  box-shadow:0 10px 28px rgba(255,168,77,.14);
  font-weight:800; max-width:100%; flex-wrap:wrap; justify-content:center;
}
.theme-chip b{
  color:#ffd0c4; font-weight:900; font-size:16px;
  text-transform:capitalize; white-space:normal; word-break:break-word; overflow-wrap:anywhere;
}
.kpi{
  min-width:66px; text-align:center; padding:6px 10px; border-radius:8px;
  border:1px solid var(--line); background:#140f1a; font-weight:800; color:#ffeef0;
  box-shadow: inset 0 0 0 1px #21162b;
}

/* ===== Tip imposteur ===== */
.tip{
  margin:8px 0 12px; padding:8px 12px;
  background: linear-gradient(180deg, rgba(255,230,150,.12), rgba(255,230,150,.08));
  border:1px solid rgba(255,230,150,.35);
  border-radius:8px; color:#ffe696; font-size:.95rem; font-style:italic; display:none;
  box-shadow:0 10px 24px rgba(255,230,150,.08);
}

/* ===== Signature ===== */
.title-line{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.signature-badge{
  font-size:13px; font-weight:800; letter-spacing:.2px; color:var(--ink); opacity:.9;
  padding:4px 10px; border-radius:999px; border:1px solid var(--line);
  background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 18%, transparent), color-mix(in srgb, var(--accent-2) 10%, transparent));
  box-shadow: 0 6px 16px rgba(255,168,77,.12);
}
.signature-badge::before{ content:'âœ¦'; margin-right:6px; opacity:.9; }

/* ===== Bouton PWA ===== */
#btn-install{
  position:sticky; top:0; z-index:1000; width:100%;
  border-radius:0; padding:12px 16px; font-weight:800; display:none;
  background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%));
  color:#2a0e16; border:0;
}

/* ===== Responsive ===== */
@media (max-width:600px){
  html, body { overscroll-behavior-y: contain; }
  .wrap{ padding:10px }
  .card{ padding:12px; border-radius:14px }
  .row{ flex-direction:column; align-items:stretch; gap:8px }
  .hero{ gap:10px; padding:12px }
  .hero svg{ width:46px; height:46px; flex:0 0 46px }
  .hero h1{ font-size:22px }
  .muted{ font-size:14px }
  h3.section-title{ font-size:16px }
  .hint-word{ font-size:24px; word-break:break-word }
  input, button{ padding:12px; font-size:15px; min-height:44px }
  .tabs{ margin-top:10px }
  .tab-btn{ padding:10px 12px; font-size:14px }
  .tab-btn[aria-selected="true"]{ margin:6px }
  .tab-pane{ padding:10px }
  .phase-bar{ grid-template-columns:1fr; gap:6px; text-align:center; padding:8px 10px }
  .phase-left, .phase-center, .phase-right{ justify-content:center }
  .kpi{ min-width:auto; padding:6px 8px; font-size:14px }
  .theme-chip{ padding:6px 10px; gap:6px }
  .theme-chip b{ font-size:15px }
  #hints p{ padding:8px 10px; font-size:15px }
  .grid-votes{ grid-template-columns:1fr; gap:8px }
  #vote-buttons button{ padding-right:38px; font-size:15px }
  #players .player, #players div{ padding:8px 10px; border-radius:10px; background:#140f1a; border:1px solid var(--line) }
  #scoreboard{ position:static; margin:12px 10px 18px; padding:10px }
  #scoreboard ul{ grid-template-columns:1fr auto; row-gap:6px }
  #scoreboard li span:first-child{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .pill{ padding:5px 8px; font-size:13px }
  .role{ padding:6px 10px; font-size:13px }
  .signature-badge{ font-size:12px; padding:4px 8px }
  #modal .box{ max-width:92vw; width:92vw; padding:14px }
}

</style>
</head>
<body class="stars">

  <!-- Bouton PWA (manquait) -->
<button id="btn-install" type="button" style="display:none;
  position:sticky; top:0; width:100%;
  background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%));
  color:#4d0d17; border:0; padding:12px 16px; font-weight:800;">
  Installer lâ€™app
</button>

  <!-- MODAL GAME OVER -->
  <div id="modal">
    <div class="box">
      <h3>Vainqueur ðŸŽ‰</h3>
      <p id="winners-text"></p>
      <div class="row">
        <button id="btn-modal-lobby" type="button" class="btn-secondary">Retour au salon</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <div class="card" id="screen-home">
      <div class="hero">
        <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M92 102c0 6-5 11-11 11H39a11 11 0 0 1-11-11V58a33 33 0 0 1 33-33h9a33 33 0 0 1 33 33v23c0 6-5 11-11 11h-2z" fill="#1c2742"/>
          <rect x="74" y="68" width="26" height="20" rx="10" fill="#303b66"/>
          <rect x="20" y="64" width="20" height="38" rx="10" fill="#1c2742"/>
          <rect x="42" y="28" width="56" height="28" rx="14" fill="#31b2f3"/>
          <rect x="50" y="34" width="34" height="16" rx="8" fill="#7fd7ff"/>
        </svg>
        <div>
          <div class="title-line">
            <h1>Hint or Lie</h1>
            <span class="signature-badge" title="CrÃ©Ã© par Mits">by Mits</span>
          </div>
          <div class="muted"><strong>Chaque indice compte.</strong> Bluffez, suspectez, et attrapez lâ€™intrus.</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Actions">
        <div class="tab-nav">
          <button class="tab-btn" id="tab-join" role="tab" aria-controls="pane-join" aria-selected="true" type="button">Rejoindre</button>
          <button class="tab-btn" id="tab-create" role="tab" aria-controls="pane-create" aria-selected="false" type="button">CrÃ©er</button>
        </div>
        <div id="pane-join" class="tab-pane active" role="tabpanel" aria-labelledby="tab-join">
          <div class="row" style="align-items:flex-end">
            <input id="name-join" placeholder="Ton pseudo" maxlength="16" />
            <input id="join-code" placeholder="Code salle" maxlength="4" />
            <button id="btn-join" type="button">Rejoindre</button>
          </div>
          <p class="muted" style="text-align:right;margin:6px 2px 0 0">Code de salle ex : <code>4831</code></p>
        </div>
        <div id="pane-create" class="tab-pane" role="tabpanel" aria-labelledby="tab-create">
          <div class="row" style="align-items:flex-end">
            <input id="name-create" placeholder="Ton pseudo" maxlength="16" />
            <button id="btn-create" type="button">CrÃ©er une salle</button>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>

      <button class="btn-secondary" id="btn-how" type="button">RÃ¨gles rapides</button>
      <div id="how" class="rules" style="display:none">
        <h4>RÃ¨gles â€” en 4 points</h4>
        <ul>
          <li>La plupart ont le <strong>mÃªme mot</strong>, un joueur a un <strong>mot diffÃ©rent</strong> (imposteur).</li>
          <li><strong>Indice :</strong> chacun donne <strong>1 mot</strong> liÃ© au thÃ¨me, sans le rÃ©vÃ©ler.</li>
          <li><strong>Vote :</strong> on choisit le suspect, puis rÃ©vÃ©lation et points.</li>
          <li><strong>Victoire :</strong> premier Ã  <strong>10 points</strong>.</li>
        </ul>
      </div>
      <div class="rules" id="lb" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <h4 style="margin:0">PalmarÃ¨s â€” Top 50</h4>
          <button class="btn-secondary" id="btn-lb-refresh" type="button">Actualiser</button>
        </div>
        <div id="lb-list" class="muted" style="margin-top:8px">Chargementâ€¦</div>
      </div>
    </div>

    <!-- LOBBY -->
    <div class="card" id="screen-lobby" style="display:none">
      <div class="row">
        <div class="pill" id="host-badge" style="display:none">Tu es l'hÃ´te</div>
        <div class="pill">Manche <span id="round-num">0</span></div>
        <div class="pill">Code <span id="lobby-code"></span></div>
        <div class="pill" id="lobby-ready-pill">0/0 prÃªts</div>
        <div class="pill" id="timer-lobby" style="display:none">00:10</div>
      </div>

      <h3 class="section-title">Joueurs</h3>
      <div id="players" class="list" style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:8px"></div>

      <div class="row" id="lobby-actions">
        <button id="btn-ready" type="button">Je suis prÃªt</button>
      </div>

      <div class="rules">
        <h4>RÃ¨gles â€” Hint or Lie</h4>
        <ul>
          <li>La plupart ont le <strong>mÃªme mot</strong>, un joueur a un <strong>mot diffÃ©rent</strong> (imposteur).</li>
          <li><strong>Indice :</strong> chacun donne 1 mot liÃ© au thÃ¨me, sans rÃ©vÃ©ler le mot.</li>
          <li><strong>Vote :</strong> on choisit le suspect. RÃ©vÃ©lation & points.</li>
          <li><strong>Victoire :</strong> premier Ã  <strong>10 points</strong>.</li>
        </ul>
      </div>
    </div>

    <!-- HINT -->
    <div class="card" id="screen-hint" style="display:none">
      <div class="phase-bar">
        <div class="phase-left">
          <span id="my-role" class="role">RÃ´le</span>
        </div>
        <div class="phase-center">
          <span class="theme-chip">ðŸ“Œ ThÃ¨me : <b id="theme-hint-name">?</b></span>
        </div>
        <div class="phase-right">
          <span class="kpi" id="timer-hints">00:45</span>
          <span class="kpi" id="progress-hints">0/0</span>
        </div>
      </div>

      <div id="impostor-tip" class="tip">ðŸŽ­ <em>MÃªme thÃ¨me, autre mot. Fais croire que tu es lâ€™un dâ€™eux.</em></div>

      <h3 class="section-title">Ton mot</h3>
      <div id="my-word" class="hint-word">?</div>
      <p class="muted" id="hint-instruction" style="margin-top:6px">Donne 1 mot liÃ© au thÃ¨me sans le rÃ©vÃ©ler. ðŸ“Œ</p>
      <input id="hint-input" placeholder="Ton indice" maxlength="40" />
      <div class="row"><button id="btn-send-hint" type="button">Envoyer l'indice</button></div>
      <p class="muted" id="hint-status"></p>
    </div>

    <!-- VOTE -->
    <div class="card" id="screen-vote" style="display:none">
      <div class="phase-bar">
        <div class="phase-left"></div>
        <div class="phase-center">
          <span class="theme-chip">ðŸ“Œ ThÃ¨me : <b id="theme-vote-name">?</b></span>
        </div>
        <div class="phase-right">
          <span class="kpi" id="timer-vote">00:40</span>
          <span class="kpi" id="progress-vote">0/0</span>
        </div>
      </div>

      <h3 class="section-title">Vote</h3>
      <p class="muted" style="margin-bottom:8px">Lis les indices puis choisis le suspect.</p>
      <div id="hints" style="margin:8px 0"></div>
      <div id="vote-buttons" class="grid-votes"></div>
    </div>

    <!-- RESULT -->
    <div class="card" id="screen-result" style="display:none">
      <div class="phase-bar">
        <div class="phase-left"></div>
        <div class="phase-center">
          <span class="theme-chip">ðŸ“Œ ThÃ¨me : <b id="res-domain">?</b></span>
        </div>
        <div class="phase-right">
          <span class="kpi" id="timer-reveal">--:--</span>
          <span class="kpi" id="progress-ready">0/0 prÃªts</span>
        </div>
      </div>

      <div id="personal-banner" class="result-banner">RÃ©sultat</div>
      <h3 class="section-title">RÃ©sumÃ©</h3>
      <p>Mot commun : <strong id="res-common"></strong> â€” Mot imposteur : <strong id="res-imp"></strong></p>
      <p>Imposteur : <strong id="res-imp-name"></strong></p>
      <div id="res-votes" style="margin:8px 0"></div>
      <div class="row"><button id="btn-next" type="button" style="display:none">Manche suivante</button></div>
    </div>
  </div>

  <!-- SCOREBOARD (global, masquÃ© sur Home via JS) -->
  <div id="scoreboard">
    <h4>Scores</h4>
    <ul id="score-list"></ul>
  </div>

  <p class="muted" id="toast" style="display:none;text-align:center" aria-live="polite"></p>

  <script>
    const $ = (id) => document.getElementById(id);
    const socket = io();

    function getDeviceId(){
      const k='hol_device'; let id = localStorage.getItem(k);
      if(!id){ id = 'd-' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k,id); }
      return id;
    }

    function tierFromWins(w){
      if (w>=120) return 'Diamond';
      if (w>=60)  return 'Platinum';
      if (w>=25)  return 'Gold';
      if (w>=10)  return 'Silver';
      return 'Bronze';
    }

    // Safe element helper
    function el(tag, text, attrs){
      const e = document.createElement(tag);
      if (text != null) e.textContent = String(text);
      if (attrs) for (const [k,v] of Object.entries(attrs)) e.setAttribute(k,v);
      return e;
    }

    // Leaderboard render (safe)
    function renderLeaderboard(items){
      const meId = getDeviceId();
      const box = $('lb-list');
      if (!Array.isArray(items) || !items.length){
        if (box) box.textContent = 'Aucun rÃ©sultat pour lâ€™instant.';
        return;
      }
      const frag = document.createDocumentFragment();
      const ul = document.createElement('ul');
      ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
      items.forEach((x, i)=>{
        const li = document.createElement('li');
        li.style.display='grid';
        li.style.gridTemplateColumns='minmax(24px,40px) 1fr auto';
        li.style.gap='8px';
        li.style.padding='6px 0';

        const rank = el('span', `#${i+1}`);
        const mid  = document.createElement('span');
        const strong = el('strong', x.pseudo || 'Joueur');
        const pill = el('span', tierFromWins(x.wins||0), { class: 'pill' });
        pill.style.marginLeft = '6px';
        mid.appendChild(strong);
        mid.appendChild(pill);
        if (x.deviceId === meId) mid.appendChild(el('span',' (toi)'));

        const wins = el('span', `${x.wins||0} victoires`, { class: 'muted' });

        li.appendChild(rank);
        li.appendChild(mid);
        li.appendChild(wins);
        ul.appendChild(li);
      });
      frag.appendChild(ul);
      if (box){ box.innerHTML=''; box.appendChild(frag); }
    }

    // ===== Leaderboard: bouton + auto-refresh =====
    function requestLeaderboard(){ socket.emit('getLeaderboard'); }

    (function setupLeaderboardUI(){
      const btn = $('btn-lb-refresh');
      if (!btn) return;
      const original = btn.textContent;
      let refreshing = false;

      const onData = (items)=>{
        renderLeaderboard(items);
        if (refreshing){
          refreshing = false;
          btn.disabled = false;
          btn.textContent = original;
        }
      };
      socket.off?.('leaderboardData', onData);
      socket.on('leaderboardData', onData);

      btn.onclick = ()=>{
        if (refreshing) return;
        refreshing = true;
        btn.disabled = true;
        btn.textContent = '...';
        requestLeaderboard();
        setTimeout(()=>{
          if (refreshing){
            refreshing = false;
            btn.disabled = false;
            btn.textContent = original;
          }
        }, 1500);
      };

      let timer = null;
      const start = ()=>{
        if (!timer){
          requestLeaderboard();
          timer = setInterval(requestLeaderboard, 45000);
        }
      };
      const stop = ()=>{ if (timer){ clearInterval(timer); timer = null; } };

      document.addEventListener('visibilitychange', ()=> document.hidden ? stop() : start());
      socket.on('connect', start);
      start();
    })();

    let me = { id: null, code: null };
    let room = { players: [], state: 'lobby' };
    let myIsImpostor = false;
    let myLobbyReady = false;

    /* ===== Barre de progression fluide (RAF) ===== */
    const DUR = { hints: 45_000, voting: 40_000, prestart: 3_000 };
    let lobbyTotalMs = 0;
    let currentPhase = null;
    let lastBeepSec = null;
    let lastBeepAt = 0;
    let phaseChangeAt = 0;

    function beep(){
      if (typeof SOUND_ENABLED === 'undefined' || !SOUND_ENABLED) return;
      // plug-in son ici si besoin
    }
    function flash(id){
      const el = document.getElementById(id); if(!el) return;
      el.style.outline='2px solid #ef4444'; setTimeout(()=>el.style.outline='',150);
    }
    function safeBeepOncePerSecond(leftMs){
      const now = Date.now();
      if (now - phaseChangeAt < 200) return;
      const sec = Math.round(leftMs / 1000);
      if (sec >= 1 && sec <= 3) {
        if (now - lastBeepAt >= 700 && sec !== lastBeepSec) {
          beep(); lastBeepSec = sec; lastBeepAt = now;
        }
      } else { lastBeepSec = null; }
    }

    const phaseAnim = { phase:null, deadline:0, total:0, raf:null };
    function stopPhaseAnim(){ if (phaseAnim.raf) cancelAnimationFrame(phaseAnim.raf); phaseAnim.raf = null; }
    function phaseScope(phase){
      if (phase === 'hints')   return document.querySelector('#screen-hint .phase-bar');
      if (phase === 'voting')  return document.querySelector('#screen-vote .phase-bar');
      if (phase === 'prestart')return document.querySelector('#screen-result .phase-bar');
      if (phase === 'lobby')   return document.querySelector('#screen-lobby .phase-bar');
      return null;
    }
    function tickPhase(){
      const el = phaseScope(phaseAnim.phase);
      if (!el) return;
      const left = Math.max(0, phaseAnim.deadline - Date.now());
      const pct = Math.max(0, Math.min(1, 1 - (left / phaseAnim.total)));
      el.style.setProperty('--progress', pct.toFixed(4));
      if (pct < 1 && phaseAnim.phase) phaseAnim.raf = requestAnimationFrame(tickPhase);
    }
    function startPhaseAnim(phase, totalMs, leftMs){
      if (!phase || !totalMs) return;
      phaseAnim.phase = phase;
      phaseAnim.total = totalMs;
      phaseAnim.deadline = Date.now() + (leftMs ?? totalMs);
      stopPhaseAnim();
      phaseAnim.raf = requestAnimationFrame(tickPhase);
    }
    function resetPhaseProgress(){
      document.querySelectorAll('.phase-bar').forEach(el=> el.style.setProperty('--progress','0'));
      stopPhaseAnim();
    }

    /* Helpers UI */
    function show(id){
      for(const el of document.querySelectorAll('.card')) el.style.display='none';
      $(id).style.display='block';
      const sb=$('scoreboard'); if(sb) sb.style.display = (id==='screen-home') ? 'none' : 'block';
      document.body.setAttribute('data-screen', id);
    }
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
    function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

    /* Tabs */
    const tabs = { join: $('tab-join'), create: $('tab-create') };
    const panes = { join: $('pane-join'), create: $('pane-create') };
    function activateTab(which){
      const isJoin = which === 'join';
      tabs.join.setAttribute('aria-selected', isJoin ? 'true' : 'false');
      tabs.create.setAttribute('aria-selected', isJoin ? 'false' : 'true');
      panes.join.classList.toggle('active', isJoin);
      panes.create.classList.toggle('active', !isJoin);
      (isJoin ? $('name-join') : $('name-create'))?.focus();
    }
    tabs.join.addEventListener('click', ()=>activateTab('join'));
    tabs.create.addEventListener('click', ()=>activateTab('create'));

    /* Filtre code: chiffres, 4 max */
    $('join-code')?.addEventListener('input', e=>{
      e.target.value = e.target.value.replace(/\D/g,'').slice(0,4);
    });

    /* Home actions */
    $('btn-join').onclick=()=>{
      const name = $('name-join')?.value.trim() || 'Joueur';
      const code = $('join-code')?.value.trim();
      const deviceId = getDeviceId();
      socket.emit('hello', { deviceId, pseudo: name });
      socket.emit('joinRoom',{code,name,deviceId});
    };
    $('btn-create').onclick=()=>{
      const name=$('name-create')?.value.trim()||'Joueur';
      const deviceId = getDeviceId();
      socket.emit('hello', { deviceId, pseudo: name });
      socket.emit('createRoom',{name,deviceId});
    };

    /* Toggle rÃ¨gles */
    $('btn-how').addEventListener('click', ()=>{
      const panel = $('how');
      const visible = panel.style.display !== 'none';
      panel.style.display = visible ? 'none' : 'block';
      $('btn-how').textContent = visible ? 'RÃ¨gles rapides' : 'Masquer les rÃ¨gles';
    });

    /* Lobby */
    $('btn-ready').onclick=()=>{
      myLobbyReady = !myLobbyReady;
      $('btn-ready').textContent = myLobbyReady ? 'Annuler prÃªt' : 'Je suis prÃªt';
      socket.emit('playerReadyLobby', { ready: myLobbyReady });
    };
    $('btn-next').onclick=()=>{
      $('btn-next').disabled = true;
      $('btn-next').textContent = 'PrÃªt âœ“';
      socket.emit('playerReadyNext');
    };
    $('btn-modal-lobby').onclick=()=>{ show('screen-lobby'); $('modal').style.display='none'; };

    /* Hint submit */
    $('btn-send-hint').onclick=()=>{
      const hint=$('hint-input').value.trim();
      if(!hint){ toast('Ã‰cris un indice ðŸ˜‰'); return; }
      socket.emit('submitHint',{hint});
      $('btn-send-hint').disabled=true;
      $('hint-input').disabled=true;
      $('hint-status').textContent="Indice envoyÃ©â€¦";
    };

    /* ENTER helpers */
    function onEnter(id, handler){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); handler(); }
      });
    }
    onEnter('name-join', ()=> $('btn-join')?.click());
    onEnter('join-code', ()=> $('btn-join')?.click());
    onEnter('name-create', ()=> $('btn-create')?.click());
    onEnter('hint-input', ()=>{
      const btn = $('btn-send-hint');
      const val = $('hint-input')?.value.trim();
      if(btn && !btn.disabled && val) btn.click();
    });

    /* ENTER global (screens) */
    document.addEventListener('keydown', (e)=>{
      if(e.key !== 'Enter') return;
      const ae = document.activeElement;
      const typing = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
      if(typing) return;

      const screen = document.body.getAttribute('data-screen');

      if(screen === 'screen-lobby'){
        $('btn-ready')?.click();
      } else if(screen === 'screen-result'){
        const b = $('btn-next');
        if(b && b.style.display !== 'none' && !b.disabled){ b.click(); }
      } else if(screen === 'screen-home'){
        const joinPaneActive = $('pane-join')?.classList.contains('active');
        const primary = joinPaneActive ? $('btn-join') : $('btn-create');
        primary?.click();
      } else if(screen === 'screen-vote'){
        const btn = document.querySelector('#vote-buttons button:not(:disabled)');
        if(btn) btn.click();
      }
    });

    /* ROOM & GAME SOCKETS */
    socket.on('connect',()=>{ socket.emit('getLeaderboard'); me.id=socket.id; });

    socket.on('roomCreated',({code})=>{
      me.code=code;
      $('lobby-code').textContent=code;
      show('screen-lobby');
      $('host-badge').style.display='inline-block';
      myLobbyReady = false;
      $('btn-ready').textContent = 'Je suis prÃªt';
      $('timer-lobby').style.display='none';
    });

    socket.on('roomJoined',({code})=>{
      me.code=code;
      $('lobby-code').textContent=code;
      show('screen-lobby');
      myLobbyReady = false;
      $('btn-ready').textContent = 'Je suis prÃªt';
      $('timer-lobby').style.display='none';
    });

    socket.on('roomUpdate',(snap)=>{
      room=snap; $('round-num').textContent=snap.round;
      const list=$('players'); list.innerHTML='';
      snap.players.forEach(p=>{
        const a=document.createElement('div'); a.textContent = p.name;
        list.appendChild(a);
      });
      updateScoreboard(snap.players);
    });

    function updateScoreboard(players){
      const ul=$('score-list'); if(!players||!ul) return;
      ul.innerHTML='';
      players.slice().sort((a,b)=>b.score-a.score).forEach(p=>{
        const li=document.createElement('li');
        const left = el('span', p.name);
        const right = el('span', String(p.score));
        li.appendChild(left); li.appendChild(right);
        ul.appendChild(li);
      });
    }

    socket.on('lobbyReadyProgress', ({ ready, total })=>{
      const pill = $('lobby-ready-pill'); if (pill) pill.textContent = `${ready}/${total} prÃªts`;
    });
    socket.on('lobbyCountdownStarted', ({ seconds })=>{
      $('timer-lobby').style.display='inline-block';
      toast(`Tout le monde est prÃªt ! DÃ©part dans ${seconds}sâ€¦`);
      lobbyTotalMs = seconds * 1000;
      resetPhaseProgress();
    });
    socket.on('lobbyCountdownCancelled', ()=>{
      $('timer-lobby').style.display='none';
      if (myLobbyReady) {
        myLobbyReady = false;
        $('btn-ready').textContent = 'Je suis prÃªt';
      }
      toast('Un joueur a rejoint. DÃ©compte annulÃ©, remettez-vous prÃªts.');
      lobbyTotalMs = 0;
      resetPhaseProgress();
    });

    /* PHASE INDICES */
    socket.on('roundInfo',({word,isImpostor,domain})=>{
      myIsImpostor = !!isImpostor;
      show('screen-hint');
      resetPhaseProgress();

      $('theme-hint-name').textContent = domain || '?';
      const roleEl=$('my-role');
      roleEl.textContent=isImpostor?'Tu es IMPOSTEUR':'Tu es Ã‰quipier';
      roleEl.className='role '+(isImpostor?'imp':'crew');

      const tip = $('impostor-tip'); if (tip) tip.style.display = isImpostor ? 'block' : 'none';

      $('hint-instruction').textContent = isImpostor
        ? "Donne 1 mot qui pourrait coller au thÃ¨me. ðŸ“Œ"
        : "Donne 1 mot liÃ© au thÃ¨me sans le rÃ©vÃ©ler. ðŸ“Œ";
      $('my-word').textContent=word;

      $('hint-input').value=''; $('hint-input').disabled=false;
      $('btn-send-hint').disabled=false; $('hint-status').textContent='';
      $('timer-vote').textContent='00:40';
      $('progress-hints').textContent='0/0';
      $('progress-vote').textContent='0/0';
      $('timer-reveal').textContent='--:--';
    });
    socket.on('hintAck', ()=>{ $('hint-status').textContent="Indice acceptÃ© âœ“"; });
    socket.on('hintRejected', ({reason})=>{
      $('hint-status').textContent = `RefusÃ© : ${reason}`;
      $('btn-send-hint').disabled=false;
      $('hint-input').disabled=false;
      $('hint-input').focus();
    });

    /* PHASE VOTE */
    socket.on('allHints', ({hints, domain})=>{
      show('screen-vote');
      $('theme-vote-name').textContent = domain || '?';
      resetPhaseProgress();

      const box = $('hints'); 
      box.innerHTML = '';
      hints.forEach(h=>{
        const p = document.createElement('p');
        const b = el('strong', h.name);
        p.appendChild(b);
        p.appendChild(document.createTextNode(' : ' + (h.hint || '')));
        box.appendChild(p);
      });

      const cont = $('vote-buttons');
      cont.innerHTML = '';
      let selectedId = null;
      const renderSelection = ()=>{
        Array.from(cont.querySelectorAll('button')).forEach(b=>{
          const sel = b.dataset.id === selectedId;
          b.classList.toggle('selected', sel);
          b.setAttribute('aria-pressed', sel ? 'true' : 'false');
        });
      };

      hints.forEach(h=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = h.name;
        btn.dataset.id = h.id;
        btn.setAttribute('aria-pressed','false');
        btn.onclick = ()=>{
          selectedId = h.id;
          renderSelection();
          socket.emit('submitVote', { targetId: h.id });
          toast('Vote envoyÃ© (modifiable)');
        };
        cont.appendChild(btn);
      });
    });

    /* PROGRESS + LOCK */
    socket.on('phaseProgress', ({ phase, submitted, total }) => {
      if (phase === 'hints') {
        const elp = $('progress-hints'); if (elp) elp.textContent = `${submitted}/${total}`;
      } else if (phase === 'voting') {
        const elv = $('progress-vote'); if (elv) elv.textContent = `${submitted}/${total}`;
        if (submitted === total) {
          const cont = $('vote-buttons');
          if (cont) Array.from(cont.querySelectorAll('button')).forEach(b => b.disabled = true);
        }
      }
    });

    /* Timers pilotÃ©s serveur */
    socket.on('timer', ({ phase, leftMs })=>{
      if (phase !== currentPhase) {
        currentPhase = phase;
        lastBeepSec = null;
        lastBeepAt = 0;
        phaseChangeAt = Date.now();
      }
      const totalFor = (ph)=> ph==='hints'?DUR.hints
                            : ph==='voting'?DUR.voting
                            : ph==='prestart'?DUR.prestart
                            : ph==='lobby'?lobbyTotalMs : 0;
      startPhaseAnim(phase, totalFor(phase), leftMs);
      const left = Math.floor((leftMs + 20) / 1000);

      if (phase === 'hints') {
        const el = $('timer-hints'); if (el) el.textContent = fmt(leftMs);
        if (left > 0 && left <= 3) { flash('timer-hints'); }
        safeBeepOncePerSecond(leftMs);
        if (left <= 0) { $('btn-send-hint')?.setAttribute('disabled','true'); $('hint-input')?.setAttribute('disabled','true'); }

      } else if (phase === 'voting') {
        const el = $('timer-vote'); if (el) el.textContent = fmt(leftMs);
        if (left > 0 && left <= 3) { flash('timer-vote'); }
        safeBeepOncePerSecond(leftMs);
        if (left <= 0) {
          const cont = $('vote-buttons') || document.createElement('div');
          Array.from(cont.querySelectorAll('button')).forEach(b => b.disabled = true);
        }

      } else if (phase === 'prestart') {
        const el = $('timer-reveal'); if (el) el.textContent = fmt(leftMs);
        if (left > 0 && left <= 3) { flash('timer-reveal'); }
        safeBeepOncePerSecond(leftMs);

      } else if (phase === 'lobby') {
        const el = $('timer-lobby');
        if (el) {
          el.style.display = 'inline-block';
          el.textContent = fmt(leftMs);
          if (left <= 0) el.style.display = 'none';
        }
        if (left > 0 && left <= 3) { flash('timer-lobby'); }
        safeBeepOncePerSecond(leftMs);
      }
    });

    /* RESULT */
    socket.on('roundResult',(res)=>{
      show('screen-result');

      $('res-domain').textContent=res.domain||'?';
      $('res-common').textContent=res.common;
      $('res-imp').textContent=res.impostor;
      $('res-imp-name').textContent=res.impostorName||'(?)';

      let win=false, text='';
      if (myIsImpostor){ win=!res.impostorCaught; text=win?'GAGNÃ‰ âœ… Tu es restÃ© discret.':'PERDU âŒ Tu as Ã©tÃ© repÃ©rÃ©.'; }
      else { win=res.impostorCaught; text=win?'GAGNÃ‰ âœ… Lâ€™imposteur a Ã©tÃ© dÃ©masquÃ©.':'PERDU âŒ Lâ€™imposteur tâ€™a eu.'; }
      const banner=$('personal-banner');
      banner.textContent=text;
      banner.className='result-banner '+(win?'result-win':'result-lose');

      const box=$('res-votes'); box.innerHTML=''; const ul=document.createElement('ul');
      for(const [tid,c] of Object.entries(res.votes)){
        const name=(room.players.find(p=>p.id===tid)||{}).name||tid;
        const li=document.createElement('li'); li.textContent=`${name} : ${c} vote(s)`; ul.appendChild(li);
      }
      box.appendChild(ul);

      $('btn-next').style.display='block';
      $('btn-next').disabled=false;
      $('btn-next').textContent='Manche suivante';

      const total=(room.players||[]).length||0;
      const pr=$('progress-ready'); if(pr) pr.textContent=`0/${total} prÃªts`;
      const tr=$('timer-reveal'); if(tr) tr.textContent='--:--';
    });

    /* PrÃªt entre manches */
    socket.on('readyProgress', ({ ready, total }) => {
      const el = $('progress-ready'); if (el) el.textContent = `${ready}/${total} prÃªts`;
    });

    /* Divers */
    socket.on('gameOver', ({ winners, autoReset })=>{
      const names=winners.map(w=>`${w.name} (${w.score})`).join(', ');
      $('winners-text').textContent = winners.length>1 ? `Ã‰galitÃ© ! ${names}` : `${names} gagne la partie !`;
      $('modal').style.display='flex';
      show('screen-lobby');
      myLobbyReady = false;
      $('btn-ready').textContent = 'Je suis prÃªt';
      $('timer-lobby').style.display='none';
      if (autoReset) toast('Scores rÃ©initialisÃ©s automatiquement');
    });
    socket.on('scoresReset', ()=>{ toast('Scores remis Ã  0'); show('screen-lobby'); });
    socket.on('actionAck', ({ action })=>{ if(action==='startRound') toast('Manche dÃ©marrÃ©e ðŸš€'); if(action==='nextRound') toast('Nouvelle manche âž¡ï¸'); });
    socket.on('errorMsg', (m)=>toast(m));

    /* Affichage initial */
    show('screen-home');

    /* PWA install & Service Worker */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = $('btn-install'); if (btn) btn.style.display = 'inline-block';
    });
    $('btn-install')?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      const btn = $('btn-install'); if (btn) btn.style.display = 'none';
    });

    // Refresh leaderboard manual (failsafe)
    $('btn-lb-refresh')?.addEventListener('click', ()=> socket.emit('getLeaderboard'));
  </script>
</body>
</html>
