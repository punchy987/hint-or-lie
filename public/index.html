<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hint or Lie ¬∑ by Mits</title>
<link rel="prefetch" href="/images/background-hero.svg?v=1" as="image" type="image/svg+xml">
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/style.css">
  <meta name="theme-color" content="#0f0b14">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
</head>
<body class="stars">
  
  <!-- Bouton PWA -->
  <button id="btn-install" type="button" style="display:none;position:sticky;top:0;width:100%;background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%));color:#4d0d17;border:0;padding:12px 16px;font-weight:800;">
    Installer l‚Äôapp
  </button>

  <!-- MODAL GAME OVER -->
  <div id="modal">
    <div class="box">
      <h3>Vainqueur üéâ</h3>
      <p id="winners-text"></p>
      <div class="row">
        <button id="btn-modal-lobby" type="button" class="btn-secondary">Retour au salon</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <div class="card" id="screen-home">
      <div class="hero">
        <!-- ‚ö° Remplacement du petit logo bleu: on utilise ton ic√¥ne -->
        <img src="/icons/icon-192.png" alt="Hint or Lie" style="width:62px;height:62px;flex:0 0 62px;filter: drop-shadow(0 8px 18px rgba(255,168,77,.25));border-radius:14px;object-fit:cover" onerror="this.style.display='none'">
        <div>
          <div class="title-line">
            <h1>Hint or Lie</h1>
            <span class="signature-badge" title="Cr√©√© par Mits">by Mits</span>
          </div>
          <div class="muted"><strong>Chaque indice compte.</strong> Bluffez, suspectez, et attrapez l‚Äôintrus.</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Actions">
        <div class="tab-nav">
          <button class="tab-btn" id="tab-join" role="tab" aria-controls="pane-join" aria-selected="true" type="button">Rejoindre</button>
          <button class="tab-btn" id="tab-create" role="tab" aria-controls="pane-create" aria-selected="false" type="button">Cr√©er</button>
        </div>
        <div id="pane-join" class="tab-pane active" role="tabpanel" aria-labelledby="tab-join">
          <div class="row" style="align-items:flex-end">
            <input id="name-join" placeholder="Ton pseudo" maxlength="16" />
            <input id="join-code" placeholder="Code salle" maxlength="4" />
            <button id="btn-join" type="button">Rejoindre</button>
          </div>
          <p class="muted" style="text-align:right;margin:6px 2px 0 0">Code de salle ex : <code>4831</code></p>
        </div>
        <div id="pane-create" class="tab-pane" role="tabpanel" aria-labelledby="tab-create">
          <div class="row" style="align-items:flex-end">
            <input id="name-create" placeholder="Ton pseudo" maxlength="16" />
            <button id="btn-create" type="button">Cr√©er une salle</button>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>

      <button class="btn-secondary" id="btn-how" type="button">R√®gles rapides</button>
      <div id="how" class="rules" style="display:none">
        <h4>R√®gles ‚Äî en 4 points</h4>
        <ul>
          <li>La plupart ont le <strong>m√™me mot</strong>, un joueur a un <strong>mot diff√©rent</strong> (imposteur).</li>
          <li><strong>Indice :</strong> chacun donne <strong>1 mot</strong> li√© au th√®me, sans le r√©v√©ler.</li>
          <li><strong>Vote :</strong> on choisit le suspect, puis r√©v√©lation et points.</li>
          <li><strong>Victoire :</strong> premier √† <strong>10 points</strong>.</li>
        </ul>
      </div>
      <div class="rules" id="lb" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <h4 style="margin:0">Classement ‚Äî Top 10</h4>
          <button class="btn-secondary" id="btn-lb-refresh" type="button">Actualiser</button>
        </div>
        <div id="lb-list" class="muted" style="margin-top:8px">Chargement‚Ä¶</div>
      </div>
    </div>
    <!-- Bandeau "Mise √† jour disponible" -->
<div id="update-banner" style="display:none">
  <div class="update-card">
    <strong>Nouvelle version disponible</strong>
    <div class="update-actions">
      <button id="update-reload" type="button">Mettre √† jour</button>
      <button id="update-dismiss" type="button">Plus tard</button>
    </div>
  </div>
</div>

    <!-- LOBBY -->
    <div class="card" id="screen-lobby" style="display:none">
      <div class="row">
        <div class="pill" id="host-badge" style="display:none">Tu es l'h√¥te</div>
        <div class="pill">Manche <span id="round-num">0</span></div>
        <div class="pill">Code <span id="lobby-code"></span></div>
        <div class="pill" id="lobby-ready-pill">0/0 pr√™ts</div>
        <div class="pill" id="timer-lobby" style="display:none">00:10</div>
      </div>

      <h3 class="section-title">Joueurs</h3>
      <div id="players" class="list" style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:8px"></div>

      <div class="row" id="lobby-actions">
        <button id="btn-ready" type="button">Je suis pr√™t</button>
        <!-- üîô Nouveau: retour √† l‚Äôaccueil pour corriger une mauvaise salle -->
        <button id="btn-back-home" type="button" class="btn-secondary">Retour √† l‚Äôaccueil</button>
      </div>

      <div class="rules">
        <h4>R√®gles ‚Äî Hint or Lie</h4>
        <ul>
          <li>La plupart ont le <strong>m√™me mot</strong>, un joueur a un <strong>mot diff√©rent</strong> (imposteur).</li>
          <li><strong>Indice :</strong> chacun donne 1 mot li√© au th√®me, sans r√©v√©ler le mot.</li>
          <li><strong>Vote :</strong> on choisit le suspect. R√©v√©lation & points.</li>
          <li><strong>Victoire :</strong> premier √† <strong>10 points</strong>.</li>
        </ul>
      </div>
    </div>

    <!-- HINT -->
    <div class="card" id="screen-hint" style="display:none">
      <div class="phase-bar">
        <div class="phase-left">
          <span id="my-role" class="role">R√¥le</span>
        </div>
        <div class="phase-center">
          <span class="theme-chip">üìå Th√®me : <b id="theme-hint-name">?</b></span>
        </div>
        <div class="phase-right">
          <div class="pill s" data-role="round">Manche <span class="round-live">0</span></div>
          <span class="kpi" id="timer-hints">00:45</span>
          <span class="kpi" id="progress-hints">0/0</span>
        </div>
      </div>

      <div id="impostor-tip" class="tip">üé≠ <em>M√™me th√®me, autre mot. Fais croire que tu es l‚Äôun d‚Äôeux.</em></div>

      <h3 class="section-title">Ton mot</h3>
      <div id="my-word" class="hint-word">?</div>
      <p class="muted" id="hint-instruction" style="margin-top:6px">Donne 1 mot li√© au th√®me sans le r√©v√©ler. üìå</p>
      <input id="hint-input" placeholder="Ton indice" maxlength="40" />
      <div class="row"><button id="btn-send-hint" type="button">Envoyer l'indice</button></div>
      <p class="muted" id="hint-status"></p>
    </div>

    <!-- VOTE -->
    <div class="card" id="screen-vote" style="display:none">
      <div class="phase-bar">
        <div class="phase-left"></div>
        <div class="phase-center">
          <span class="theme-chip">üìå Th√®me : <b id="theme-vote-name">?</b></span>
        </div>
        <div class="phase-right">
          <div class="pill s" data-role="round">Manche <span class="round-live">0</span></div>
          <span class="kpi" id="timer-vote">00:40</span>
          <span class="kpi" id="progress-vote">0/0</span>
        </div>
      </div>

      <h3 class="section-title">Vote</h3>
      <p class="muted" style="margin-bottom:8px">Lis les indices puis choisis le suspect.</p>
      <div id="hints" style="margin:8px 0"></div>
      <div id="vote-buttons" class="grid-votes"></div>
    </div>

    <!-- RESULT -->
    <div class="card" id="screen-result" style="display:none">
      <div class="phase-bar">
        <div class="phase-left"></div>
        <div class="phase-center">
          <span class="theme-chip">üìå Th√®me : <b id="res-domain">?</b></span>
        </div>
        <div class="phase-right">
          <div class="pill s" data-role="round">Manche <span class="round-live">0</span></div>
          <span class="kpi" id="timer-reveal">--:--</span>
          <span class="kpi" id="progress-ready">0/0 pr√™ts</span>
        </div>
      </div>

      <div id="personal-banner" class="result-banner">R√©sultat</div>
      <h3 class="section-title">R√©sum√©</h3>
      <p>Mot commun : <strong id="res-common"></strong> ‚Äî Mot imposteur : <strong id="res-imp"></strong></p>
      <p>Imposteur : <strong id="res-imp-name"></strong></p>
      <div id="res-votes" style="margin:8px 0"></div>
      <div class="row"><button id="btn-next" type="button" style="display:none">Manche suivante</button></div>
    </div>
  </div>

  <!-- SCOREBOARD (masqu√© sur Home & Lobby via JS) -->
  <div id="scoreboard">
    <h4>Scores</h4>
    <ul id="score-list"></ul>
  </div>

  <p class="muted" id="toast" style="display:none;text-align:center" aria-live="polite"></p>
  <!-- Bandeau "Mise √† jour disponible" -->
<div id="update-banner" style="display:none">
  <div class="update-card">
    <strong>Nouvelle version disponible</strong>
    <div class="update-actions">
      <button id="update-reload" type="button">Mettre √† jour</button>
      <button id="update-dismiss" type="button">Plus tard</button>
    </div>
  </div>
</div>


  <script>
    const $ = (id) => document.getElementById(id);
    const socket = io();

    function getDeviceId(){
      const k='hol_device'; let id = localStorage.getItem(k);
      if(!id){ id = 'd-' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k,id); }
      return id;
    }
 
(function(){
  if (!('serviceWorker' in navigator)) return;

  function showUpdateBanner(reg){
    var el = document.getElementById('update-banner');
    if (!el) return;
    el.style.display = 'block';

    var btnReload = document.getElementById('update-reload');
    var btnDismiss = document.getElementById('update-dismiss');

    btnDismiss && (btnDismiss.onclick = function(){ el.style.display = 'none'; });
    btnReload  && (btnReload.onclick  = function(){
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    });

    navigator.serviceWorker.addEventListener('controllerchange', function(){
      window.location.reload();
    }, { once: true });
  }

  navigator.serviceWorker.register('/sw.js').then(function(reg){
    // MAJ d√©j√† pr√™te
    if (reg.waiting && navigator.serviceWorker.controller) {
      showUpdateBanner(reg);
    }

    // MAJ d√©tect√©e
    reg.addEventListener('updatefound', function(){
      var sw = reg.installing;
      if (!sw) return;
      sw.addEventListener('statechange', function(){
        if (sw.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdateBanner(reg);
        }
      });
    });

    // V√©rifier r√©guli√®rement + au retour au premier plan (mobile/PWA)
    function poke(){ reg.update().catch(()=>{}); }
    document.addEventListener('visibilitychange', function(){ if (document.visibilityState === 'visible') poke(); });
    window.addEventListener('focus', poke);
    setInterval(poke, 5 * 60 * 1000);
  });
})();


  // Affiche le bandeau et branche les boutons
  function showUpdateBanner(reg){
    var el = document.getElementById('update-banner');
    var btnReload = document.getElementById('update-reload');
    var btnDismiss = document.getElementById('update-dismiss');
    if (!el || !btnReload || !btnDismiss) return;

    el.style.display = 'block';

    btnDismiss.onclick = function(){
      el.style.display = 'none';
    };

    btnReload.onclick = function(){
      // Demande au SW "waiting" de passer actif imm√©diatement
      if (reg.waiting) {
        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      }
    };

    // Quand le contr√¥leur change => la nouvelle version est active => on recharge
    navigator.serviceWorker.addEventListener('controllerchange', function(){
      window.location.reload();
    }, { once: true });
  }
    function tierFromWins(w){
      if (w>=120) return 'Diamond';
      if (w>=60)  return 'Platinum';
      if (w>=25)  return 'Gold';
      if (w>=10)  return 'Silver';
      return 'Bronze';
    }

    // Safe element helper
    function el(tag, text, attrs){
      const e = document.createElement(tag);
      if (text != null) e.textContent = String(text);
      if (attrs) for (const [k,v] of Object.entries(attrs)) e.setAttribute(k,v);
      return e;
    }

    // Leaderboard render (safe)
    function renderLeaderboard(items){
      const meId = getDeviceId();
      const box = $('lb-list');
      if (!Array.isArray(items) || !items.length){
        if (box) box.textContent = 'Aucun r√©sultat pour l‚Äôinstant.';
        return;
      }
      const frag = document.createDocumentFragment();
      const ul = document.createElement('ul');
      ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
      items.forEach((x, i)=>{
        const li = document.createElement('li');
        li.style.display='grid';
        li.style.gridTemplateColumns='minmax(24px,40px) 1fr auto';
        li.style.gap='8px';
        li.style.padding='6px 0';

        const rank = el('span', `#${i+1}`);
        const mid  = document.createElement('span');
        const strong = el('strong', x.pseudo || 'Joueur');
        const pill = el('span', tierFromWins(x.wins||0), { class: 'pill' });
        pill.style.marginLeft = '6px';
        mid.appendChild(strong);
        mid.appendChild(pill);
        if (x.deviceId === meId) mid.appendChild(el('span',' (toi)'));

        const wins = el('span', `${x.wins||0} victoires`, { class: 'muted' });

        li.appendChild(rank);
        li.appendChild(mid);
        li.appendChild(wins);
        ul.appendChild(li);
      });
      frag.appendChild(ul);
      if (box){ box.innerHTML=''; box.appendChild(frag); }
    }

    // ===== Leaderboard: bouton + auto-refresh =====
    function requestLeaderboard(){ socket.emit('getLeaderboard'); }

    (function setupLeaderboardUI(){
      const btn = $('btn-lb-refresh');
      if (!btn) return;
      const original = btn.textContent;
      let refreshing = false;

      const onData = (items)=>{
        renderLeaderboard(items);
        if (refreshing){
          refreshing = false;
          btn.disabled = false;
          btn.textContent = original;
        }
      };
      socket.off?.('leaderboardData', onData);
      socket.on('leaderboardData', onData);

      btn.onclick = ()=>{
        if (refreshing) return;
        refreshing = true;
        btn.disabled = true;
        btn.textContent = '...';
        requestLeaderboard();
        setTimeout(()=>{
          if (refreshing){
            refreshing = false;
            btn.disabled = false;
            btn.textContent = original;
          }
        }, 1500);
      };

      let timer = null;
      const start = ()=>{
        if (!timer){
          requestLeaderboard();
          timer = setInterval(requestLeaderboard, 45000);
        }
      };
      const stop = ()=>{ if (timer){ clearInterval(timer); timer = null; } };

      document.addEventListener('visibilitychange', ()=> document.hidden ? stop() : start());
      socket.on('connect', start);
      start();
    })();

    let me = { id: null, code: null };
    let room = { players: [], state: 'lobby' };
    let myIsImpostor = false;
    let myLobbyReady = false;

    /* ===== Barre de progression fluide (RAF) ===== */
    const DUR = { hints: 45_000, voting: 40_000, prestart: 3_000 };
    let lobbyTotalMs = 0;
    let currentPhase = null;
    let lastBeepSec = null;
    let lastBeepAt = 0;
    let phaseChangeAt = 0;

    function beep(){ /* optionnel */ }
    function flash(id){ const el = document.getElementById(id); if(!el) return; el.style.outline='2px solid #ef4444'; setTimeout(()=>el.style.outline='',150); }

    function safeBeepOncePerSecond(leftMs){ /* idem */ }

    const phaseAnim = { phase:null, deadline:0, total:0, raf:null };
    function stopPhaseAnim(){ if (phaseAnim.raf) cancelAnimationFrame(phaseAnim.raf); phaseAnim.raf = null; }
    function phaseScope(phase){
      if (phase === 'hints')   return document.querySelector('#screen-hint .phase-bar');
      if (phase === 'voting')  return document.querySelector('#screen-vote .phase-bar');
      if (phase === 'prestart')return document.querySelector('#screen-result .phase-bar');
      if (phase === 'lobby')   return document.querySelector('#screen-lobby .phase-bar');
      return null;
    }
    function tickPhase(){
      const el = phaseScope(phaseAnim.phase);
      if (!el) return;
      const left = Math.max(0, phaseAnim.deadline - Date.now());
      const pct = Math.max(0, Math.min(1, 1 - (left / phaseAnim.total)));
      el.style.setProperty('--progress', pct.toFixed(4));
      if (pct < 1 && phaseAnim.phase) phaseAnim.raf = requestAnimationFrame(tickPhase);
    }
    function startPhaseAnim(phase, totalMs, leftMs){
      if (!phase || !totalMs) return;
      phaseAnim.phase = phase; phaseAnim.total = totalMs; phaseAnim.deadline = Date.now() + (leftMs ?? totalMs);
      stopPhaseAnim(); phaseAnim.raf = requestAnimationFrame(tickPhase);
    }
    function resetPhaseProgress(){ document.querySelectorAll('.phase-bar').forEach(el=> el.style.setProperty('--progress','0')); stopPhaseAnim(); }

    /* Helpers UI */
    function show(id){
      for(const el of document.querySelectorAll('.card')) el.style.display='none';
      $(id).style.display='block';
      const sb=$('scoreboard'); if(sb) sb.style.display = (id==='screen-hint'||id==='screen-vote'||id==='screen-result') ? 'block' : 'none';
      document.body.setAttribute('data-screen', id);
    }
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
    function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

    /* Tabs */
    const tabs = { join: $('tab-join'), create: $('tab-create') };
    const panes = { join: $('pane-join'), create: $('pane-create') };
    function activateTab(which){
      const isJoin = which === 'join';
      tabs.join.setAttribute('aria-selected', isJoin ? 'true' : 'false');
      tabs.create.setAttribute('aria-selected', isJoin ? 'false' : 'true');
      panes.join.classList.toggle('active', isJoin);
      panes.create.classList.toggle('active', !isJoin);
      (isJoin ? $('name-join') : $('name-create'))?.focus();
    }
    tabs.join.addEventListener('click', ()=>activateTab('join'));
    tabs.create.addEventListener('click', ()=>activateTab('create'));

    /* Filtre code */
    $('join-code')?.addEventListener('input', e=>{ e.target.value = e.target.value.replace(/\D/g,'').slice(0,4); });

    /* Home actions */
    $('btn-join').onclick=()=>{
      const name = $('name-join')?.value.trim() || 'Joueur';
      const code = $('join-code')?.value.trim();
      const deviceId = getDeviceId();
      socket.emit('hello', { deviceId, pseudo: name });
      socket.emit('joinRoom',{code,name,deviceId});
    };
    $('btn-create').onclick=()=>{
      const name=$('name-create')?.value.trim()||'Joueur';
      const deviceId = getDeviceId();
      socket.emit('hello', { deviceId, pseudo: name });
      socket.emit('createRoom',{name,deviceId});
    };

    /* Toggle r√®gles */
    $('btn-how').addEventListener('click', ()=>{
      const panel = $('how');
      const visible = panel.style.display !== 'none';
      panel.style.display = visible ? 'none' : 'block';
      $('btn-how').textContent = visible ? 'R√®gles rapides' : 'Masquer les r√®gles';
    });

    /* Lobby */
    $('btn-ready').onclick=()=>{
      myLobbyReady = !myLobbyReady;
      $('btn-ready').textContent = myLobbyReady ? 'Annuler pr√™t' : 'Je suis pr√™t';
      socket.emit('playerReadyLobby', { ready: myLobbyReady });
    };

    // üîô Retour √† l‚Äôaccueil: on demande au serveur de nous retirer de la salle
    $('btn-back-home').onclick=()=>{
      socket.emit('leaveRoom');
      myLobbyReady = false;
      $('btn-ready').textContent = 'Je suis pr√™t';
      show('screen-home');
    };

    $('btn-next').onclick=()=>{
      $('btn-next').disabled = true;
      $('btn-next').textContent = 'Pr√™t ‚úì';
      socket.emit('playerReadyNext');
    };
    $('btn-modal-lobby').onclick=()=>{ show('screen-lobby'); $('modal').style.display='none'; };

    /* Hint submit */
    $('btn-send-hint').onclick=()=>{
      const hint=$('hint-input').value.trim();
      if(!hint){ toast('√âcris un indice üòâ'); return; }
      socket.emit('submitHint',{hint});
      $('btn-send-hint').disabled=true;
      $('hint-input').disabled=true;
      $('hint-status').textContent="Indice envoy√©‚Ä¶";
    };

    /* ENTER helpers */
    function onEnter(id, handler){ const el = document.getElementById(id); if(!el) return; el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); handler(); } }); }
    onEnter('name-join', ()=> $('btn-join')?.click());
    onEnter('join-code', ()=> $('btn-join')?.click());
    onEnter('name-create', ()=> $('btn-create')?.click());
    onEnter('hint-input', ()=>{ const btn = $('btn-send-hint'); const val = $('hint-input')?.value.trim(); if(btn && !btn.disabled && val) btn.click(); });

    /* ENTER global (screens) */
    document.addEventListener('keydown', (e)=>{
      if(e.key !== 'Enter') return;
      const ae = document.activeElement;
      const typing = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
      if(typing) return;

      const screen = document.body.getAttribute('data-screen');
      if(screen === 'screen-lobby'){
        $('btn-ready')?.click();
      } else if(screen === 'screen-result'){
        const b = $('btn-next'); if(b && b.style.display !== 'none' && !b.disabled){ b.click(); }
      } else if(screen === 'screen-home'){
        const joinPaneActive = $('pane-join')?.classList.contains('active');
        const primary = joinPaneActive ? $('btn-join') : $('btn-create');
        primary?.click();
      } else if(screen === 'screen-vote'){
        const btn = document.querySelector('#vote-buttons button:not(:disabled)');
        if(btn) btn.click();
      }
    });

    /* ROOM & GAME SOCKETS */
    socket.on('connect',()=>{ socket.emit('getLeaderboard'); me.id=socket.id; });

    socket.on('roomCreated',({code})=>{
      me.code=code; $('lobby-code').textContent=code; show('screen-lobby');
      $('host-badge').style.display='inline-block';
      myLobbyReady = false; $('btn-ready').textContent = 'Je suis pr√™t';
      $('timer-lobby').style.display='none';
    });

    socket.on('roomJoined',({code})=>{
      me.code=code; $('lobby-code').textContent=code; show('screen-lobby');
      myLobbyReady = false; $('btn-ready').textContent = 'Je suis pr√™t';
      $('timer-lobby').style.display='none';
    });

    socket.on('roomUpdate',(snap)=>{
      room=snap; $('round-num').textContent=snap.round;
      const list=$('players'); list.innerHTML='';
      snap.players.forEach(p=>{ const a=document.createElement('div'); a.textContent = p.name; list.appendChild(a); });
      updateScoreboard(snap.players);
    });

    function updateScoreboard(players){
      const ul=$('score-list'); if(!players||!ul) return;
      ul.innerHTML='';
      players.slice().sort((a,b)=>b.score-a.score).forEach(p=>{
        const li=document.createElement('li');
        const left = el('span', p.name);
        const right = el('span', String(p.score));
        li.appendChild(left); li.appendChild(right);
        ul.appendChild(li);
      });
    }

    socket.on('lobbyReadyProgress', ({ ready, total })=>{ const pill = $('lobby-ready-pill'); if (pill) pill.textContent = `${ready}/${total} pr√™ts`; });
    socket.on('lobbyCountdownStarted', ({ seconds })=>{
      $('timer-lobby').style.display='inline-block'; toast(`Tout le monde est pr√™t ! D√©part dans ${seconds}s‚Ä¶`);
      lobbyTotalMs = seconds * 1000; resetPhaseProgress();
    });
    socket.on('lobbyCountdownCancelled', ()=>{
      $('timer-lobby').style.display='none';
      if (myLobbyReady) { myLobbyReady = false; $('btn-ready').textContent = 'Je suis pr√™t'; }
      toast('Un joueur a rejoint/quitt√©.Remettez-vous pr√™ts.');
      lobbyTotalMs = 0; resetPhaseProgress();
    });

    /* PHASE INDICES */
    socket.on('roundInfo',({word,isImpostor,domain})=>{
      myIsImpostor = !!isImpostor; show('screen-hint'); resetPhaseProgress();
      $('theme-hint-name').textContent = domain || '?';
      const roleEl=$('my-role'); roleEl.textContent=isImpostor?'Tu es IMPOSTEUR':'Tu es √âquipier'; roleEl.className='role '+(isImpostor?'imp':'crew');
      const tip = $('impostor-tip'); if (tip) tip.style.display = isImpostor ? 'block' : 'none';
      $('hint-instruction').textContent = isImpostor ? "Donne 1 mot qui pourrait coller au th√®me. üìå" : "Donne 1 mot li√© au th√®me sans le r√©v√©ler. üìå";
      $('my-word').textContent=word;
      $('hint-input').value=''; $('hint-input').disabled=false; $('btn-send-hint').disabled=false; $('hint-status').textContent='';
      $('timer-vote').textContent='00:40'; $('progress-hints').textContent='0/0'; $('progress-vote').textContent='0/0'; $('timer-reveal').textContent='--:--';
    });
    socket.on('hintAck', ()=>{ $('hint-status').textContent="Indice accept√© ‚úì"; });
    socket.on('hintRejected', ({reason})=>{ $('hint-status').textContent = `Refus√© : ${reason}`; $('btn-send-hint').disabled=false; $('hint-input').disabled=false; $('hint-input').focus(); });

    /* PHASE VOTE */
    socket.on('allHints', ({hints, domain})=>{
      show('screen-vote'); $('theme-vote-name').textContent = domain || '?'; resetPhaseProgress();
      const box = $('hints'); box.innerHTML = '';
      hints.forEach(h=>{ const p = document.createElement('p'); const b = el('strong', h.name); p.appendChild(b); p.appendChild(document.createTextNode(' : ' + (h.hint || ''))); box.appendChild(p); });
      const cont = $('vote-buttons'); cont.innerHTML = '';
      let selectedId = null;
      const renderSelection = ()=>{ Array.from(cont.querySelectorAll('button')).forEach(b=>{ const sel = b.dataset.id === selectedId; b.classList.toggle('selected', sel); b.setAttribute('aria-pressed', sel ? 'true' : 'false'); }); };
      hints.forEach(h=>{ const btn = document.createElement('button'); btn.type = 'button'; btn.textContent = h.name; btn.dataset.id = h.id; btn.setAttribute('aria-pressed','false'); btn.onclick = ()=>{ selectedId = h.id; renderSelection(); socket.emit('submitVote', { targetId: h.id }); toast('Vote envoy√© (modifiable)'); }; cont.appendChild(btn); });
    });

    /* PROGRESS + LOCK */
    socket.on('phaseProgress', ({ phase, submitted, total }) => {
      if (phase === 'hints') {
        const elp = $('progress-hints'); if (elp) elp.textContent = `${submitted}/${total}`;
      } else if (phase === 'voting') {
        const elv = $('progress-vote'); if (elv) elv.textContent = `${submitted}/${total}`;
        if (submitted === total) { const cont = $('vote-buttons'); if (cont) Array.from(cont.querySelectorAll('button')).forEach(b => b.disabled = true); }
      }
    });

    /* Timers pilot√©s serveur */
    socket.on('timer', ({ phase, leftMs })=>{
      if (phase !== currentPhase) { currentPhase = phase; }
      const totalFor = (ph)=> ph==='hints'?DUR.hints : ph==='voting'?DUR.voting : ph==='prestart'?DUR.prestart : ph==='lobby'?lobbyTotalMs : 0;
      startPhaseAnim(phase, totalFor(phase), leftMs);
      const left = Math.floor((leftMs + 20) / 1000);
      if (phase === 'hints') { const el = $('timer-hints'); if (el) el.textContent = fmt(leftMs); if (left <= 0) { $('btn-send-hint')?.setAttribute('disabled','true'); $('hint-input')?.setAttribute('disabled','true'); } }
      else if (phase === 'voting') { const el = $('timer-vote'); if (el) el.textContent = fmt(leftMs); if (left <= 0) { const cont = $('vote-buttons') || document.createElement('div'); Array.from(cont.querySelectorAll('button')).forEach(b => b.disabled = true); } }
      else if (phase === 'prestart') { const el = $('timer-reveal'); if (el) el.textContent = fmt(leftMs); }
      else if (phase === 'lobby') { const el = $('timer-lobby'); if (el) { el.style.display = 'inline-block'; el.textContent = fmt(leftMs); if (left <= 0) el.style.display = 'none'; } }
    
    });

    /* RESULT */
    socket.on('roundResult',(res)=>{
      show('screen-result');
      $('res-domain').textContent=res.domain||'?'; $('res-common').textContent=res.common; $('res-imp').textContent=res.impostor; $('res-imp-name').textContent=res.impostorName||'(?)';
      let win=false, text=''; if (myIsImpostor){ win=!res.impostorCaught; text=win?'GAGN√â ‚úÖ Tu es rest√© discret.':'PERDU ‚ùå Tu as √©t√© rep√©r√©.'; } else { win=res.impostorCaught; text=win?'GAGN√â ‚úÖ L‚Äôimposteur a √©t√© d√©masqu√©.':'PERDU ‚ùå L‚Äôimposteur t‚Äôa eu.'; }
      const banner=$('personal-banner'); banner.textContent=text; banner.className='result-banner '+(win?'result-win':'result-lose');
      const box=$('res-votes'); box.innerHTML=''; const ul=document.createElement('ul');
      for(const [tid,c] of Object.entries(res.votes)){ const name=(room.players.find(p=>p.id===tid)||{}).name||tid; const li=document.createElement('li'); li.textContent=`${name} : ${c} vote(s)`; ul.appendChild(li); }
      box.appendChild(ul);
      $('btn-next').style.display='block'; $('btn-next').disabled=false; $('btn-next').textContent='Manche suivante';
      const total=(room.players||[]).length||0; const pr=$('progress-ready'); if(pr) pr.textContent=`0/${total} pr√™ts`; const tr=$('timer-reveal'); if(tr) tr.textContent='--:--';
    });

    /* Pr√™t entre manches */
    socket.on('readyProgress', ({ ready, total }) => { const el = $('progress-ready'); if (el) el.textContent = `${ready}/${total} pr√™ts`; });

    /* Divers */
    socket.on('gameOver', ({ winners, autoReset })=>{
      const names=winners.map(w=>`${w.name} (${w.score})`).join(', ');
      $('winners-text').textContent = winners.length>1 ? `√âgalit√© ! ${names}` : `${names} gagne la partie !`;
      $('modal').style.display='flex'; show('screen-lobby'); myLobbyReady = false; $('btn-ready').textContent = 'Je suis pr√™t'; $('timer-lobby').style.display='none'; if (autoReset) toast('Scores r√©initialis√©s automatiquement');
    });
    socket.on('scoresReset', ()=>{ toast('Scores remis √† 0'); show('screen-lobby'); });
    socket.on('actionAck', ({ action })=>{ if(action==='startRound') toast('Manche d√©marr√©e üöÄ'); if(action==='nextRound') toast('Nouvelle manche ‚û°Ô∏è'); });
    socket.on('errorMsg', (m)=>toast(m));

    /* Affichage initial */
    show('screen-home');

    // Refresh leaderboard manual (failsafe)
    $('btn-lb-refresh')?.addEventListener('click', ()=> socket.emit('getLeaderboard'));
  
(function(){
  var flashArmed = false;
  var lastPhase = null;

  function attach(){
    if (!window.socket) return setTimeout(attach, 50);  // attend que socket soit dispo
    socket.on('timer', function(payload){
      var phase = payload && payload.phase;
      var leftMs = (payload && payload.leftMs) || 0;

      if (phase !== lastPhase) {
        lastPhase = phase;
        flashArmed = false;  // nouvelle phase -> on r√©arme
      }

      // d√©clenche 1 flash en fin de d√©compte
      if (leftMs <= 240 && !flashArmed) {
        flashArmed = true;
        document.documentElement.classList.add('flash-now');
        setTimeout(function(){
          document.documentElement.classList.remove('flash-now');
        }, 260);
      }

      // si le timer remonte (nouvelle phase), on r√©arme
      if (leftMs > 240) {
        flashArmed = false;
      }
    });
  }
  attach();
})();
const LIMIT = 10;                 // ‚Üê Top 10
  const KEY = 'holLeaderboard';

  function loadLB(){
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch(e){ return []; }
  }
  function saveLB(list){
    localStorage.setItem(KEY, JSON.stringify(list.slice(0, LIMIT)));
  }

  function updateLocalLB(winners){
    const lb = loadLB();
    const byName = new Map(lb.map(e => [e.name, e]));
    const now = Date.now();
    for (const w of winners || []) {
      const name = String(w.name || '').trim() || 'Joueur';
      const score = Number(w.score || 0);
      let row = byName.get(name);
      if (!row) {
        row = { name, wins: 0, bestScore: 0, last: 0 };
        byName.set(name, row);
      }
      row.wins += 1;
      if (score > row.bestScore) row.bestScore = score;
      row.last = now;
    }
    const list = Array.from(byName.values())
      .sort((a,b) => b.wins - a.wins || b.bestScore - a.bestScore || a.name.localeCompare(b.name))
      .slice(0, LIMIT);

    saveLB(list);
    renderLocalLB();
  }

  function renderLocalLB(){
    const list = loadLB();
    const box = document.getElementById('lb-list');
    if (!box) return;
    if (!list.length) {
      box.classList.add('muted');
      box.innerHTML = "Aucun r√©sultat pour l‚Äôinstant.";
      return;
    }
    box.classList.remove('muted');
    const rows = list.map((e, i) => `
      <div class="lb-row">
        <span class="rank">${i+1}</span>
        <span class="name">${e.name}</span>
        <span class="wins">${e.wins} vic.</span>
        <span class="best">${e.bestScore} pts</span>
      </div>
    `).join('');
    box.innerHTML = `<div class="lb-head">
        <span class="rank">#</span><span class="name">Joueur</span><span class="wins">Victoires</span><span class="best">Meilleur</span>
      </div>${rows}`;
  }

  const btn = document.getElementById('btn-lb-refresh');
  if (btn) btn.onclick = renderLocalLB;

  if (window.socket) {
    socket.on('gameOver', ({ winners }) => updateLocalLB(winners));
  } else {
    let tries = 0;
    (function waitSocket(){
      if (window.socket) return socket.on('gameOver', ({ winners }) => updateLocalLB(winners));
      if (tries++ < 40) setTimeout(waitSocket, 100);
    })();
  }

  renderLocalLB();

  if (navigator.storage && navigator.storage.persist) {
    navigator.storage.persist().catch(()=>{});
  }
/* === Synchro du num√©ro de manche dans toute l'app === */
(function(){
  function setRound(n){
    // Met √† jour toutes les pastilles "round-live"
    document.querySelectorAll('.round-live').forEach(function(el){
      el.textContent = (typeof n === 'number' ? n : 0);
    });
    // Met aussi √† jour le compteur du lobby si pr√©sent
    var l = document.getElementById('round-num');
    if (l) l.textContent = (typeof n === 'number' ? n : 0);
  }

  // 1) Au chargement, on affiche 0
  setRound(0);

  // 2) √âcoute les mises √† jour de salle (contient round)
  if (window.socket){
    socket.on('roomUpdate', function(payload){
      if (payload && typeof payload.round === 'number') setRound(payload.round);
    });
    // (optionnel) si tu √©mets "phaseProgress" avec round aussi
    socket.on('phaseProgress', function(payload){
      if (payload && typeof payload.round === 'number') setRound(payload.round);
    });
  } else {
    // si socket arrive plus tard
    var tries = 0;
    (function waitSocket(){
      if (window.socket) {
        socket.on('roomUpdate', function(p){ if (p && typeof p.round === 'number') setRound(p.round); });
        socket.on('phaseProgress', function(p){ if (p && typeof p.round === 'number') setRound(p.round); });
      } else if (tries++ < 40) setTimeout(waitSocket, 100);
    })();
  }
})();
</script>
Le serveur envoie d√©j√† round dans roomUpdate, donc cette pastille se mettra √† jour automatiquement d√®s que la partie progresse.

Bonus (si tu veux pousser le look √† l‚Äôidentique du screenshot)
Tu peux ajouter une bordure ‚Äúglow‚Äù tr√®s l√©g√®re autour de la barre :

FICHIER : public/style.css
O√ô : en bas, ajoute :

css
Copier
Modifier
/* L√©g√®re lueur autour de la phase bar */
.phase-bar{
  border-radius: 999px;
  box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 8px 26px rgba(0,0,0,.25);
  padding: 6px 10px;
  gap: 8px;
}
</script>

</body>
</html>