<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hint or Lie</title>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b0f14;color:#e8eef6}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#121823;border:1px solid #1e2a3a;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .header-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    input,button{width:100%;padding:12px;border-radius:12px;border:1px solid #29384e;background:#0f1520;color:#e8eef6}
    button{background:#2563eb;border:none;font-weight:700;cursor:pointer}
    button:active{transform:scale(0.98)}
    .pill{padding:6px 10px;border:1px solid #29384e;border-radius:999px;display:inline-block}
    .muted{color:#9fb0c5}
    h1,h2,h3,h4{margin:0 0 8px 0}
    .role{font-weight:800;border:1px solid currentColor;border-radius:999px;padding:6px 12px;display:inline-block}
    .role.crew{color:#16a34a}
    .role.imp{color:#ef4444}
    .section-title{font-size:18px;margin:6px 0}
    .hint-word{font-size:34px;font-weight:800;letter-spacing:.3px;margin:4px 0 8px}
    #scoreboard{max-width:720px;margin:16px auto 24px;background:#0f1520;border:1px solid #29384e;border-radius:12px;padding:12px}
    #scoreboard h4{margin:0 0 8px 0;font-size:14px}
    #scoreboard ul{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:1fr auto;row-gap:6px}
    #scoreboard li{display:contents}
    #scoreboard li span:last-child{justify-self:end;color:#9fb0c5}
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
    #modal .box{background:#121823;border:1px solid #1e2a3a;border-radius:16px;padding:16px;max-width:360px}
    .result-banner{border:1px solid; border-radius:10px; padding:8px 12px; display:inline-block; margin:6px 0}
    .result-win{color:#16a34a;border-color:#16a34a}
    .result-lose{color:#ef4444;border-color:#ef4444}

    /* Mini styles pour le bloc R√àGLES du salon */
    .rules{margin-top:10px;border:1px dashed #1e2a3a;border-radius:12px;padding:12px;background:#0f1520}
    .rules h4{margin:0 0 8px 0}
    .rules ul{margin:6px 0;padding-left:18px}
  </style>
</head>
<body>

<!-- MODAL GAME OVER -->
<div id="modal">
  <div class="box">
    <h3>Vainqueur üéâ</h3>
    <p id="winners-text"></p>
    <div class="row">
      <button id="btn-modal-lobby">Retour au salon</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HOME -->
  <div class="card" id="screen-home">
    <h2>Hint or Lie</h2>
    <p class="muted" style="margin:6px 0 12px">Un imposteur a un mot diff√©rent. Donne un indice, vote, d√©masque. Premier √† 10 gagne.</p>
    <div class="row">
      <input id="name" placeholder="Ton pseudo" maxlength="16" />
      <button id="btn-create">Cr√©er</button>
    </div>
    <div class="row">
      <input id="join-code" placeholder="Code salle (ex: 4L8Q)" maxlength="6" />
      <button id="btn-join">Rejoindre</button>
    </div>
  </div>

  <!-- LOBBY -->
  <div class="card" id="screen-lobby" style="display:none">
    <div class="header-row">
      <div class="pill" id="host-badge" style="display:none">Tu es l'h√¥te</div>
      <div class="pill">Manche <span id="round-num">0</span></div>
      <div class="pill">Code <span id="lobby-code"></span></div>
      <div class="pill" id="lobby-ready-pill">0/0 pr√™ts</div>
      <div class="pill" id="timer-lobby" style="display:none">00:10</div>
    </div>

    <h3 class="section-title">Joueurs</h3>
    <div id="players" class="list" style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:8px"></div>

    <!-- Boutons salon -->
    <div class="row" id="lobby-actions">
      <button id="btn-ready">Je suis pr√™t</button>
    </div>

    <!-- R√àGLES visibles au salon -->
    <div class="rules">
      <h4>R√®gles ‚Äî Hint or Lie</h4>
      <ul>
        <li>La plupart ont le <strong>m√™me mot</strong>, un joueur a un <strong>mot diff√©rent</strong> (imposteur).</li>
        <li><strong>Indice :</strong> chacun donne 1 mot li√© au th√®me, sans r√©v√©ler le mot.</li>
        <li><strong>Vote :</strong> on choisit le suspect. R√©v√©lation &amp; points.</li>
        <li><strong>Victoire :</strong> premier √† <strong>10 points</strong>.</li>
      </ul>
      <p class="muted">Quand tout le monde clique <em>Je suis pr√™t</em>, un compte √† rebours de 10s d√©marre. Si quelqu‚Äôun rejoint : le d√©compte est annul√© et on recommence.</p>
    </div>
  </div>

  <!-- HINT -->
  <div class="card" id="screen-hint" style="display:none">
    <div class="header-row">
      <div class="pill" id="domain-pill">Domaine</div>
      <div class="pill" id="timer-hints">00:45</div>
      <div class="pill" id="progress-hints">0/0</div>
    </div>
    <div><span id="my-role" class="role">R√¥le</span></div>
    <h3 class="section-title">Ton mot</h3>
    <div id="my-word" class="hint-word">?</div>
    <p class="muted" id="hint-instruction" style="margin-top:6px">Donne 1 mot li√© au th√®me sans le r√©v√©ler.</p>
    <input id="hint-input" placeholder="Ton indice" maxlength="40" />
    <div class="row"><button id="btn-send-hint">Envoyer l'indice</button></div>
    <p class="muted" id="hint-status"></p>
  </div>

  <!-- VOTE -->
  <div class="card" id="screen-vote" style="display:none">
    <div class="header-row">
      <div class="pill" id="vote-domain-pill">Domaine</div>
      <div class="pill" id="timer-vote">00:40</div>
      <div class="pill" id="progress-vote">0/0</div>
    </div>
    <h3 class="section-title">Vote</h3>
    <p class="muted" style="margin-bottom:8px">Lis les indices puis choisis le suspect.</p>
    <div id="hints" style="margin:8px 0"></div>
    <div id="vote-buttons" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;"></div>
  </div>

  <!-- RESULT -->
  <div class="card" id="screen-result" style="display:none">
    <div class="header-row">
      <div class="pill" id="progress-ready">0/0 pr√™ts</div>
      <div class="pill" id="timer-reveal">--:--</div>
    </div>
    <div id="personal-banner" class="result-banner">R√©sultat</div>
    <h3 class="section-title">R√©sum√©</h3>
    <p class="muted"><strong>Domaine :</strong> <span id="res-domain"></span></p>
    <p>Mot commun : <strong id="res-common"></strong> ‚Äî Mot imposteur : <strong id="res-imp"></strong></p>
    <p>Imposteur : <strong id="res-imp-name"></strong></p>
    <div id="res-votes" style="margin:8px 0"></div>
    <div class="row"><button id="btn-next" style="display:none">Manche suivante</button></div>
  </div>
</div>

<!-- SCOREBOARD -->
<div id="scoreboard">
  <h4>Scores</h4>
  <ul id="score-list"></ul>
</div>

<p class="muted" id="toast" style="display:none;text-align:center"></p>

<script>
  const $ = (id) => document.getElementById(id);
  const socket = io();

  let me = { id: null, code: null };
  let room = { players: [], state: 'lobby' };
  let myIsImpostor = false;
  let myLobbyReady = false; // √©tat local: suis-je pr√™t au salon ?

  // Helpers UI
  function show(id){ for(const el of document.querySelectorAll('.card')) el.style.display='none'; $(id).style.display='block'; }
  function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
  function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
  function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop(); ctx.close();},120);}catch{} }
  function flash(id){ const el=$(id); if(!el) return; el.style.outline='2px solid #ef4444'; setTimeout(()=>el.style.outline='',150); }
  function updateScoreboard(players){
    const ul=$('score-list'); if(!players||!ul) return;
    ul.innerHTML='';
    players.slice().sort((a,b)=>b.score-a.score).forEach(p=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${p.name}</span><span>${p.score}</span>`;
      ul.appendChild(li);
    });
  }

  // HOME / LOBBY
  $('btn-create').onclick=()=>{ const name=$('name')?.value.trim()||'Joueur'; socket.emit('createRoom',{name}); };
  $('btn-join').onclick=()=>{ const name=$('name')?.value.trim()||'Joueur'; const code=$('join-code')?.value.trim().toUpperCase(); socket.emit('joinRoom',{code,name}); };

  // Nouveau: bouton pr√™t / pas pr√™t du salon
  $('btn-ready').onclick=()=>{
    myLobbyReady = !myLobbyReady;
    $('btn-ready').textContent = myLobbyReady ? 'Annuler pr√™t' : 'Je suis pr√™t';
    socket.emit('playerReadyLobby', { ready: myLobbyReady });
  };

  // Bouton "Manche suivante" (pr√™t inter-manches existant)
  $('btn-next').onclick=()=>{
    $('btn-next').disabled = true;
    $('btn-next').textContent = 'Pr√™t ‚úì';
    socket.emit('playerReadyNext');
  };
  $('btn-modal-lobby').onclick=()=>{ show('screen-lobby'); $('modal').style.display='none'; };

  $('btn-send-hint').onclick=()=>{
    const hint=$('hint-input').value.trim();
    if(!hint){ toast('√âcris un indice üòâ'); return; }
    socket.emit('submitHint',{hint});
    $('btn-send-hint').disabled=true;
    $('hint-input').disabled=true;
    $('hint-status').textContent="Indice envoy√©‚Ä¶";
  };

  // Connexion / salons
  socket.on('connect',()=>{ me.id=socket.id; });

  socket.on('roomCreated',({code})=>{
    me.code=code;
    $('lobby-code').textContent=code;
    show('screen-lobby');
    $('host-badge').style.display='inline-block';
    // Reset pr√™t salon
    myLobbyReady = false;
    $('btn-ready').textContent = 'Je suis pr√™t';
    $('timer-lobby').style.display='none';
  });

  socket.on('roomJoined',({code})=>{
    me.code=code;
    $('lobby-code').textContent=code;
    show('screen-lobby');
    // Reset pr√™t salon
    myLobbyReady = false;
    $('btn-ready').textContent = 'Je suis pr√™t';
    $('timer-lobby').style.display='none';
  });

  socket.on('roomUpdate',(snap)=>{
    room=snap; $('round-num').textContent=snap.round;
    const list=$('players'); list.innerHTML='';
    snap.players.forEach(p=>{
      const a=document.createElement('div'); a.textContent=p.name;
      const b=document.createElement('div'); b.textContent='Score: '+p.score; b.className='muted';
      list.appendChild(a); list.appendChild(b);
    });
    updateScoreboard(snap.players);
  });

  // === Pr√™t au salon ===
  socket.on('lobbyReadyProgress', ({ ready, total })=>{
    const pill = $('lobby-ready-pill'); if (pill) pill.textContent = `${ready}/${total} pr√™ts`;
  });

  socket.on('lobbyCountdownStarted', ({ seconds })=>{
    $('timer-lobby').style.display='inline-block';
    toast(`Tout le monde est pr√™t ! D√©part dans ${seconds}s‚Ä¶`);
  });

  socket.on('lobbyCountdownCancelled', ()=>{
    $('timer-lobby').style.display='none';
    if (myLobbyReady) {
      // On repasse "non pr√™t" c√¥t√© UI (le serveur a tout annul√©)
      myLobbyReady = false;
      $('btn-ready').textContent = 'Je suis pr√™t';
    }
    toast('Un joueur a rejoint. D√©compte annul√©, remettez-vous pr√™ts.');
  });

  // PHASE INDICES
  socket.on('roundInfo',({word,isImpostor,domain})=>{
    myIsImpostor = !!isImpostor;
    show('screen-hint');

    $('domain-pill').textContent=`Domaine : ${domain||'?'}`;
    const roleEl=$('my-role');
    roleEl.textContent=isImpostor?'Tu es IMPOSTEUR':'Tu es √âquipier';
    roleEl.className='role '+(isImpostor?'imp':'crew');

    $('hint-instruction').textContent = isImpostor
      ? "Donne 1 mot qui pourrait coller au th√®me."
      : "Donne 1 mot li√© au th√®me sans le r√©v√©ler.";
    $('my-word').textContent=word;

    $('hint-input').value=''; $('hint-input').disabled=false;
    $('btn-send-hint').disabled=false; $('hint-status').textContent='';
    $('timer-vote').textContent='00:40';
    $('progress-hints').textContent='0/0';
    $('progress-vote').textContent='0/0';
    $('timer-reveal').textContent='--:--';
  });

  socket.on('hintAck', ()=>{ $('hint-status').textContent="Indice accept√© ‚úì"; });
  socket.on('hintRejected', ({reason})=>{
    $('hint-status').textContent = `Refus√© : ${reason}`;
    $('btn-send-hint').disabled=false;
    $('hint-input').disabled=false;
    $('hint-input').focus();
  });

  // PHASE VOTE
  socket.on('allHints', ({hints, domain})=>{
    show('screen-vote');
    $('vote-domain-pill').textContent=`Domaine : ${domain||'?'}`;

    const box=$('hints'); box.innerHTML='';
    hints.forEach(h=>{ const p=document.createElement('p'); p.innerHTML=`<strong>${h.name}</strong> : ${h.hint||''}`; box.appendChild(p); });

    const cont=$('vote-buttons'); cont.innerHTML='';
    hints.forEach(h=>{
      const btn=document.createElement('button');
      btn.textContent=h.name;
      btn.onclick=()=>{
        btn.textContent=h.name+' ‚úì';
        Array.from(cont.querySelectorAll('button')).forEach(b=>b.disabled=true);
        socket.emit('submitVote',{targetId:h.id});
        toast('Vote envoy√©');
      };
      cont.appendChild(btn);
    });
  });

  // PHASE R√âSULTAT
  socket.on('roundResult',(res)=>{
    show('screen-result');

    $('res-domain').textContent=res.domain||'?';
    $('res-common').textContent=res.common;
    $('res-imp').textContent=res.impostor;
    $('res-imp-name').textContent=res.impostorName||'(?)';

    let win=false, text='';
    if (myIsImpostor){ win=!res.impostorCaught; text=win?'GAGN√â ‚úÖ Tu es rest√© discret.':'PERDU ‚ùå Tu as √©t√© rep√©r√©.'; }
    else { win=res.impostorCaught; text=win?'GAGN√â ‚úÖ L‚Äôimposteur a √©t√© d√©masqu√©.':'PERDU ‚ùå L‚Äôimposteur t‚Äôa eu.'; }
    const banner=$('personal-banner');
    banner.textContent=text;
    banner.className='result-banner '+(win?'result-win':'result-lose');

    const box=$('res-votes'); box.innerHTML=''; const ul=document.createElement('ul');
    for(const [tid,c] of Object.entries(res.votes)){
      const name=(room.players.find(p=>p.id===tid)||{}).name||tid;
      const li=document.createElement('li'); li.textContent=`${name} : ${c} vote(s)`; ul.appendChild(li);
    }
    box.appendChild(ul);

    $('btn-next').style.display='block';
    $('btn-next').disabled=false;
    $('btn-next').textContent='Manche suivante';

    const total=(room.players||[]).length||0;
    const pr=$('progress-ready'); if(pr) pr.textContent=`0/${total} pr√™ts`;
    const tr=$('timer-reveal'); if(tr) tr.textContent='--:--';
  });

  // Compteurs phases
  socket.on('readyProgress', ({ ready, total })=>{
    const pr=$('progress-ready'); if(pr) pr.textContent=`${ready}/${total} pr√™ts`;
  });

  socket.on('phaseProgress', ({ phase, submitted, total })=>{
    if (phase==='hints'){ const el=$('progress-hints'); if(el) el.textContent=`${submitted}/${total}`; }
    else if (phase==='voting'){ const el=$('progress-vote'); if(el) el.textContent=`${submitted}/${total}`; }
  });

  // Timers (indices / votes / pr√©-d√©marrage / lobby)
  socket.on('timer', ({ phase, leftMs })=>{
    const left=Math.ceil(leftMs/1000);
    if (phase==='hints'){
      const el=$('timer-hints'); if(el) el.textContent=fmt(leftMs);
      if (left>0 && left<=5){ flash('timer-hints'); beep(); }
      if (left<=0){ $('btn-send-hint')?.setAttribute('disabled','true'); $('hint-input')?.setAttribute('disabled','true'); }
    } else if (phase==='voting'){
      const el=$('timer-vote'); if(el) el.textContent=fmt(leftMs);
      if (left>0 && left<=5){ flash('timer-vote'); beep(); }
      if (left<=0){ const cont=$('vote-buttons')||document.createElement('div'); Array.from(cont.querySelectorAll('button')).forEach(b=>b.disabled=true); }
    } else if (phase==='prestart'){
      const el=$('timer-reveal'); if(el) el.textContent=fmt(leftMs);
      if (left>0 && left<=3){ flash('timer-reveal'); beep(); }
    } else if (phase==='lobby'){
      const el=$('timer-lobby'); if(el){ el.style.display='inline-block'; el.textContent=fmt(leftMs); }
      if (left>0 && left<=5){ flash('timer-lobby'); beep(); }
    }
  });

  // Game over & divers
  socket.on('gameOver', ({ winners, autoReset })=>{
    const names=winners.map(w=>`${w.name} (${w.score})`).join(', ');
    $('winners-text').textContent = winners.length>1 ? `√âgalit√© ! ${names}` : `${names} gagne la partie !`;
    $('modal').style.display='flex';
    show('screen-lobby');
    // Reset pr√™t salon
    myLobbyReady = false;
    $('btn-ready').textContent = 'Je suis pr√™t';
    $('timer-lobby').style.display='none';
    if (autoReset) toast('Scores r√©initialis√©s automatiquement');
  });

  socket.on('scoresReset', ()=>{ toast('Scores remis √† 0'); show('screen-lobby'); });
  socket.on('actionAck', ({ action })=>{ if(action==='startRound') toast('Manche d√©marr√©e üöÄ'); if(action==='nextRound') toast('Nouvelle manche ‚û°Ô∏è'); });
  socket.on('errorMsg', (m)=>toast(m));
</script>
</body>
</html>
