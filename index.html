<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hint or Lie · by Mits</title>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f0b14">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">

  <!-- ===== Thème Sunset Pop + UI (verre + néon chaud) ===== -->
  <style>
    :root{
      color-scheme: dark;
      /* Sunset Pop */
      --bg:#0f0b14;        /* fond global */
      --card:#17121f;      /* panneaux */
      --line:#2a2135;      /* bordures */
      --ink:#fff7f1;       /* texte principal */
      --text:#fff7f1;      /* alias */
      --muted:#ccb6d9;     /* texte secondaire */
      --accent:#ff7a59;    /* orange corail */
      --accent-2:#e24ecf;  /* rose/violet */
      --accent-3:#2bd97f;  /* succès */
      --shadow: rgba(0,0,0,.35);
      --glow: 0 0 40px rgba(255,122,89,.18);
    }

    /* ===== Reset & fond ===== */
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--ink);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(255,122,89,.08), transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, rgba(226,78,207,.08), transparent 60%),
                  var(--bg);
      overflow-y:auto;
    }
    .stars::before, .stars::after{
      content:""; position:fixed; inset:-20% -10% -10% -10%; pointer-events:none; z-index:-1;
      background-image: radial-gradient(#ffffff66 1px, transparent 1px);
      background-size: 3px 3px; opacity:.10; filter:drop-shadow(0 0 2px #ffffff33);
      animation: drift 160s linear infinite;
    }
    .stars::after{ opacity:.08; background-size: 2px 2px; animation-duration: 220s; }
    @keyframes drift{ from{ transform:translateY(0)} to{ transform:translateY(200px)} }

    /* ===== Layout ===== */
    .layout{ max-width: 1100px; margin: 24px auto; padding: clamp(12px,2vw,24px); display:grid; gap:24px; }
    @media (min-width: 980px){ .layout{ grid-template-columns: 1fr 360px; align-items: start; } }
    .stack{ display:grid; gap:16px }
    .wrap{ max-width:1100px; margin:0 auto; padding: clamp(12px,2vw,24px) }

    /* ===== Cards (verre) ===== */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.025));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px; padding: 16px 16px 18px; backdrop-filter: blur(8px);
      box-shadow: 0 24px 60px rgba(0,0,0,.40), var(--glow);
    }
    .card.glow{ box-shadow: 0 18px 45px color-mix(in srgb, var(--accent) 35%, transparent); }
    .card h3{ margin: 0 0 8px; font-size: clamp(18px, 2vw, 20px); letter-spacing:.3px; }

    /* ===== Segmented (Rejoindre/Créer) ===== */
    .segmented{ display:flex; gap:6px; background: rgba(255,255,255,.05); padding:6px; border-radius:14px; border:1px solid rgba(255,255,255,.12); }
    .segmented button{ flex:1; border:0; padding:12px 10px; border-radius:10px; font-weight:800; background: transparent; color: var(--muted); transition:.2s; cursor:pointer; }
    .segmented button.is-active{
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 70%, transparent), color-mix(in srgb, var(--accent-2) 40%, transparent));
      color:#2a0e16; box-shadow: inset 0 -2px 0 rgba(0,0,0,.15), 0 6px 20px rgba(0,0,0,.35);
    }

    /* ===== Inputs ===== */
    .input{
      width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      color: var(--text); padding: 14px 14px; font-size:16px; outline: none; transition:.2s;
    }
    .input::placeholder{ color:#bfa8c7 }
    .input:focus{ border-color: color-mix(in srgb, var(--accent) 60%, white 0%); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent); }

    /* ===== CTA ===== */
    .btn-cta{
      display:block; width:100%; font-weight:900; letter-spacing:.3px; padding:14px 18px; border-radius:14px; border:0;
      background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%));
      color:#2a0e16; box-shadow: 0 12px 28px color-mix(in srgb, var(--accent) 35%, transparent);
      transition: transform .06s ease, filter .2s ease; cursor:pointer;
    }
    .btn-cta:hover{ filter:brightness(1.06); }
    .btn-cta:active{ transform: translateY(1px); }
    .btn-secondary{ background:#0f1523; border:1px solid var(--line); color:var(--text); font-weight:700; border-radius:14px; padding:12px 14px; }

    /* ===== Badges / divers ===== */
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color: var(--muted); }
    .badge-success{ background: color-mix(in srgb, var(--accent-3) 18%, transparent); color:#03190c; }
    .pill{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; display:inline-block }
    .muted{ color:var(--muted) }
    hr.soft{ border:0; height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent); margin: 12px 0; }

    /* ===== Hero ===== */
    .hero{ display:flex; gap:16px; align-items:center; padding:16px 14px; border-radius:18px; background:linear-gradient(180deg, #1b1422, #14101b); border:1px solid var(--line); box-shadow: inset 0 0 0 1px #21162b }
    .hero h1{ font-size:28px; letter-spacing:.3px }
    .hero svg{ width:62px; height:62px; flex:0 0 62px; filter: drop-shadow(0 8px 18px rgba(255,122,89,.25)); }

    /* ===== Tabs ===== */
    .tabs{ margin-top:12px; border:1px solid var(--line); border-radius:14px; background:#140f1a }
    .tab-nav{ display:flex }
    .tab-btn{ flex:1; padding:12px 14px; border:0; background:transparent; color:#d9c1e3; font-weight:800; cursor:pointer }
    .tab-btn[aria-selected="true"]{ color:#2a0e16; background:var(--accent); border-radius:12px; margin:6px; box-shadow:0 6px 16px rgba(255,122,89,.25) }
    .tab-pane{ display:none; padding:14px }
    .tab-pane.active{ display:block }

    /* ===== Phase bar ===== */
    .phase-bar{ display:grid; grid-template-columns: 1fr minmax(320px, 1.6fr) 1fr; align-items:center; gap:12px; border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:linear-gradient(180deg, #1b1422, #14101b); box-shadow: inset 0 0 0 1px #21162b; margin-bottom:10px; position:relative; overflow:hidden }
    .phase-left{ display:flex; align-items:center; gap:8px; }
    .phase-center{ display:flex; justify-content:center }
    .phase-right{ display:flex; justify-content:flex-end; gap:10px }
    .phase-bar::after{ content:""; position:absolute; inset:0; transform-origin:left center; transform: scaleX(var(--progress, 0)); background: linear-gradient(90deg, rgba(255,122,89,.28), rgba(226,78,207,.28)); mix-blend-mode: screen; pointer-events:none }
    .kpi{ min-width:66px; text-align:center; padding:6px 10px; border-radius:8px; border:1px solid var(--line); background:#140f1a; font-weight:800; color:#ffeef0; box-shadow: inset 0 0 0 1px #21162b }
    .role{ font-weight:900; border:1px solid currentColor; border-radius:999px; padding:6px 12px; display:inline-block }
    .role.crew{ color:var(--accent-3) }
    .role.imp{ color:var(--accent-2) }
    .theme-chip{ display:flex; align-items:center; gap:8px; padding:6px 14px; border-radius:999px; border:1px solid color-mix(in srgb, var(--accent) 70%, #fff 0%); background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 18%, transparent), color-mix(in srgb, var(--accent-2) 14%, transparent)); box-shadow:0 10px 28px rgba(255,122,89,.14) }
    .theme-chip b{ color: #ffd0c4; font-weight:900; font-size:16px; text-transform:capitalize; white-space: normal; word-break: break-word; overflow-wrap: anywhere }

    /* Hints & Votes */
    #hints p{ padding:8px 10px; border-radius:10px; background:#140f1a; border:1px solid var(--line) }
    #vote-buttons{ display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:8px }
    #vote-buttons button{ position: relative; padding-right: 36px; background:#140f1a; border:1px solid var(--line); text-align:left; }
    #vote-buttons button.selected{ outline:2px solid var(--accent); box-shadow:0 0 14px rgba(255,122,89,.25) }
    #vote-buttons button.selected::after{ content:'✓'; position:absolute; right:12px; top:50%; transform:translateY(-50%); font-weight:900 }

    /* Tip imposteur */
    .tip{ margin:8px 0 12px; padding: 8px 12px; background: linear-gradient(180deg, rgba(255,230,150,.12), rgba(255,230,150,.08)); border: 1px solid rgba(255,230,150,.35); border-radius: 8px; color: #ffe696; font-size: .95rem; font-style: italic; display:none }

    /* Scoreboard & Modal */
    #scoreboard{ max-width:880px; margin:16px auto 24px; background:#140f1a; border:1px solid var(--line); border-radius:16px; padding:12px; display:none; box-shadow: 0 16px 40px rgba(0,0,0,.35) }
    #scoreboard ul{ list-style:none; padding:0; margin:0; display:grid; grid-template-columns:1fr auto; row-gap:6px }
    #scoreboard li{ display:contents }
    #scoreboard li span:last-child{ justify-self:end; color:var(--muted) }
    #modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:20 }
    #modal .box{ background:#140f1a; border:1px solid var(--line); border-radius:16px; padding:16px; max-width:360px }
    .result-banner{ border:1px solid; border-radius:10px; padding:8px 12px; display:inline-block; margin:6px 0; font-weight:800; background:#140f1a }
    .result-win{ color:var(--accent-3); border-color:rgba(43,217,127,.8); box-shadow: 0 0 20px rgba(43,217,127,.25) }
    .result-lose{ color:var(--accent-2); border-color:rgba(226,78,207,.8); box-shadow: 0 0 20px rgba(226,78,207,.25) }

    /* Signature */
    .title-line{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .signature-badge{ font-size:13px; font-weight:800; letter-spacing:.2px; color:var(--ink); opacity:.9; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 18%, transparent), color-mix(in srgb, var(--accent-2) 10%, transparent)); box-shadow: 0 6px 16px rgba(255,122,89,.12) }
    .signature-badge::before{ content:'✦'; margin-right:6px; opacity:.9 }

    /* Mobile tweaks */
    @media (max-width:600px){
      html, body { overscroll-behavior-y: contain; }
      .wrap{ max-width: 100%; padding: 10px }
      .card{ padding: 12px; border-radius: 14px }
      .hero{ gap: 10px; padding: 12px }
      .hero svg{ width: 46px; height: 46px; flex: 0 0 46px }
      .hero h1{ font-size: 22px }
      .muted{ font-size: 14px }
      h3.section-title{ font-size: 16px }
      .hint-word{ font-size: 24px; word-break: break-word }
      input, button{ padding: 12px; font-size: 15px; min-height: 44px }
      .tabs{ margin-top: 10px }
      .tab-btn{ padding: 10px 12px; font-size: 14px }
      .tab-btn[aria-selected="true"]{ margin: 6px }
      .tab-pane{ padding: 10px }
      .phase-bar{ grid-template-columns: 1fr; gap:6px; text-align:center; padding: 8px 10px }
      .phase-left, .phase-center, .phase-right{ justify-content:center }
      .kpi{ min-width: auto; padding: 6px 8px; font-size: 14px }
      .theme-chip{ padding: 6px 10px; gap: 6px }
      .theme-chip b{ font-size: 15px }
      #hints p{ padding: 8px 10px; font-size: 15px }
      #vote-buttons{ grid-template-columns:1fr; gap: 8px }
      #vote-buttons button{ padding-right: 38px; font-size: 15px }
      #players .player, #players div{ padding: 8px 10px; border-radius: 10px; background:#140f1a; border:1px solid var(--line) }
      #lb{ padding: 10px }
      #scoreboard{ position: static; margin: 12px 10px 18px; padding: 10px }
      #scoreboard ul{ grid-template-columns: 1fr auto; row-gap: 6px }
      #scoreboard li span:first-child{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap }
      .pill{ padding: 5px 8px; font-size: 13px }
      .role{ padding: 6px 10px; font-size: 13px }
      .signature-badge{ font-size: 12px; padding: 4px 8px }
      #modal .box{ max-width: 92vw; width: 92vw; padding: 14px }
    }

    /* Bouton PWA in-app (affiché via beforeinstallprompt) */
    #btn-install{ position: sticky; top: 0; z-index: 1000; width: 100%; border-radius: 0; padding: 12px 16px; font-weight: 800; display:none; background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent-2) 35%, var(--accent) 65%)); color:#2a0e16; border:0 }
  </style>
</head>

<body class="stars">
  <!-- Bouton PWA (s'affiche quand beforeinstallprompt est reçu) -->
  <button id="btn-install">Installer l’app</button>

  <!-- MODAL GAME OVER -->
  <div id="modal">
    <div class="box">
      <h3>Vainqueur 🎉</h3>
      <p id="winners-text"></p>
      <div class="row">
        <button id="btn-modal-lobby" class="btn-secondary">Retour au salon</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <div class="card" id="screen-home">
      <div class="hero">
        <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M92 102c0 6-5 11-11 11H39a11 11 0 0 1-11-11V58a33 33 0 0 1 33-33h9a33 33 0 0 1 33 33v23c0 6-5 11-11 11h-2z" fill="#3b243f"/>
          <rect x="74" y="68" width="26" height="20" rx="10" fill="#281b2f"/>
          <rect x="20" y="64" width="20" height="38" rx="10" fill="#3b243f"/>
          <rect x="42" y="28" width="56" height="28" rx="14" fill="#ff7a59"/>
          <rect x="50" y="34" width="34" height="16" rx="8" fill="#ffc5b5"/>
        </svg>
        <div>
          <div class="title-line">
            <h1>Hint or Lie</h1>
            <span class="signature-badge" title="Créé par Mits">by Mits</span>
          </div>
          <div class="muted"><strong>Chaque indice compte.</strong> Bluffez, suspectez, et attrapez l’intrus.</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Actions">
        <div class="tab-nav">
          <button class="tab-btn" id="tab-join" role="tab" aria-controls="pane-join" aria-selected="true">Rejoindre</button>
          <button class="tab-btn" id="tab-create" role="tab" aria-controls="pane-create" aria-selected="false">Créer</button>
        </div>
        <div id="pane-join" class="tab-pane active" role="tabpanel" aria-labelledby="tab-join">
          <div class="row" style="align-items:flex-end">
            <input id="name-join" class="input" placeholder="Ton pseudo" maxlength="16" />
            <input id="join-code" class="input" placeholder="Code salle" maxlength="6" />
            <button id="btn-join" class="btn-cta">Rejoindre</button>
          </div>
          <p class="muted" style="text-align:right;margin:6px 2px 0 0">Code de salle ex : <code>4831</code></p>
        </div>
        <div id="pane-create" class="tab-pane" role="tabpanel" aria-labelledby="tab-create">
          <div class="row" style="align-items:flex-end">
            <input id="name-create" class="input" placeholder="Ton pseudo" maxlength="16" />
            <button id="btn-create" class="btn-cta">Créer une salle</button>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>

      <button class="btn-secondary" id="btn-how" type="button">Règles rapides</button>
      <div id="how" class="rules" style="display:none">
        <h4>Règles — en 4 points</h4>
        <ul>
          <li>La plupart ont le <strong>même mot</strong>, un joueur a un <strong>mot différent</strong> (imposteur).</li>
          <li><strong>Indice :</strong> chacun donne <strong>1 mot</strong> lié au thème, sans le révéler.</li>
          <li><strong>Vote :</strong> on choisit le suspect, puis révélation et points.</li>
          <li><strong>Victoire :</strong> premier à <strong>10 points</strong>.</li>
        </ul>
      </div>
      <div class="rules" id="lb" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <h4 style="margin:0">Palmarès — Top 50</h4>
          <button class="btn-secondary" id="btn-lb-refresh" type="button">Actualiser</button>
        </div>
        <div id="lb-list" class="muted" style="margin-top:8px">Chargement…</div>
      </div>

    </div>

    <!-- LOBBY -->
    <div class="card" id="screen-lobby" style="display:none">
      <div class="row">
        <div class="pill" id="host-badge" style="display:none">Tu es l'hôte</div>
        <div class="pill">Manche <span id="round-num">0</span></div>
        <div class="pill">Code <span id="lobby-code"></span></div>
        <div class="pill" id="lobby-ready-pill">0/0 prêts</div>
        <div class="pill" id="timer-lobby" style="display:none">00:10</div>
      </div>

      <h3 class="section-title">Joueurs</h3>
      <div id="players" class="list" style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:8px"></div>

      <div class="row" id="lobby-actions">
        <button id="btn-ready" class="btn-cta">Je suis prêt</button>
      </div>

      <div class="rules">
        <h4>Règles — Hint or Lie</h4>
        <ul>
          <li>La plupart ont le <strong>même mot</strong>, un joueur a un <strong>mot différent</strong> (imposteur).</li>
          <li><strong>Indice :</strong> chacun donne 1 mot lié au thème, sans révéler le mot.</li>
          <li><strong>Vote :</strong> on choisit le suspect. Révélation & points.</li>
          <li><strong>Victoire :</strong> premier à <strong>10 points</strong>.</li>
        </ul>
      </div>
    </div>

    <!-- HINT -->
    <div class="card" id="screen-hint" style="display:none">
      <div class="phase-bar">
        <div class="phase-left">
          <span id="my-role" class="role">Rôle</span>
        </div>
        <div class="phase-center">
          <span class="theme-chip">📌 Thème : <b id="theme-hint-name">?</b></span>
        </div>
        <div class="phase-right">
          <span class="kpi" id="timer-hints">00:45</span>
          <span class="kpi" id="progress-hints">0/0</span>
        </div>
      </div>

      <div id="impostor-tip" class="tip">🎭 <em>Même thème, autre mot. Fais croire que tu es l’un d’eux.</em></div>
      <h3 class="section-title">Ton mot</h3>
      <div id="my-word" class="hint-word">?</div>
      <p class="muted" id="hint-instruction" style="margin-top:6px">Donne 1 mot lié au thème sans le révéler. 📌</p>
      <input id="hint-input" class="input" placeholder="Ton indice" maxlength="40" />
      <div class="row"><button id="btn-send-hint" class="btn-cta">Envoyer l'indice</button></div>
      <p class="muted" id="hint-status"></p>
    </div>

    <!-- VOTE -->
    <div class="card" id="screen-vote" style="display:none">
      <div class="phase-bar">
        <div class="phase-left"></div>
        <div class="phase-center">
          <span class="theme-chip">📌 Thème : <b id="theme-vote-name">?</b></span>
        </div>
        <div class="phase-right">
          <span class="kpi" id="timer-vote">00:40</span>
          <span class="kpi" id="progress-vote">0/0</span>
        </div>
      </div>

      <h3 class="section-title">Vote</h3>
      <p class="muted" style="margin-bottom:8px">Lis les indices puis choisis le suspect.</p>
      <div id="hints" style="margin:8px 0"></div>
      <div id="vote-buttons" class="grid-votes"></div>
    </div>

    <!-- RESULT -->
    <div class="card" id="screen-result" style="display:none">
      <div class="phase-bar">
        <div class="phase-left"></div>
        <div class="phase-center">
          <span class="theme-chip">📌 Thème : <b id="res-domain">?</b></span>
        </div>
        <div class="phase-right">
          <span class="kpi" id="timer-reveal">--:--</span>
          <span class="kpi" id="progress-ready">0/0 prêts</span>
        </div>
      </div>

      <div id="personal-banner" class="result-banner">Résultat</div>
      <h3 class="section-title">Résumé</h3>
      <p>Mot commun : <strong id="res-common"></strong> — Mot imposteur : <strong id="res-imp"></strong></p>
      <p>Imposteur : <strong id="res-imp-name"></strong></p>
      <div id="res-votes" style="margin:8px 0"></div>
      <div class="row"><button id="btn-next" class="btn-cta" style="display:none">Manche suivante</button></div>
    </div>
  </div>

  <!-- SCOREBOARD -->
  <div id="scoreboard">
    <h4>Scores</h4>
    <ul id="score-list"></ul>
  </div>

  <p class="muted" id="toast" style="display:none;text-align:center"></p>

  <!-- ========================= JS ========================= -->
  <script>
    // PWA helper (bouton in-app + SW register)
    (function pwaInstall(){
      let deferredPrompt=null;
      window.addEventListener('beforeinstallprompt', (e)=>{
        e.preventDefault(); deferredPrompt=e;
        const b=document.getElementById('btn-install'); if(b) b.style.display='block';
      });
      document.getElementById('btn-install')?.addEventListener('click', async ()=>{
        if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; document.getElementById('btn-install').style.display='none';
      });
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').catch(()=>{}); });
      }
    })();
  </script>

  <!-- === Script de jeu (collé tel quel depuis ton ancien index.html) === -->
  <script>
const $ = (id) => document.getElementById(id);
  const socket = io();
  function getDeviceId(){
    const k='hol_device'; let id = localStorage.getItem(k);
    if(!id){ id = 'd-' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k,id); }
    return id;
  }

  function tierFromWins(w){
    if (w>=120) return 'Diamond';
    if (w>=60)  return 'Platinum';
    if (w>=30)  return 'Gold';
    if (w>=15)  return 'Silver';
    return 'Bronze';
  }

  function svgTier(t){
    const map = {
      Bronze: '#cd7f32',
      Silver: '#c0c0c0',
      Gold:   '#ffd700',
      Platinum: '#7fffd4',
      Diamond: '#b9f2ff'
    };
    const col = map[t] || '#ccc';
    return `<svg width="20" height="20" viewBox="0 0 24 24" fill="${col}" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2L15 8l7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1 3-6z"/>
    </svg>`;
  }

  const BYTES = new TextEncoder();
  const DECODER = new TextDecoder();

  // const BASE_URL = location.origin.replace(/^http/,'ws');
  const ROOM_CODE_LEN = 4;

  const DUR = {
    prestart: 3000,
    hints: 45000,
    voting: 40000
  };

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  const SCREENS = ['screen-home','screen-lobby','screen-hint','screen-vote','screen-result'];
  function show(id){
    for(const s of SCREENS){
      const el = $(s); if(!el) continue;
      el.style.display = (s===id) ? '' : 'none';
    }
  }

  async function copy(text){
    try{ await navigator.clipboard.writeText(text); toast('Copié ✔'); }
    catch(e){ toast('Impossible de copier'); }
  }

  let toastTimer = null;
  function toast(msg){
    const el = $('toast');
    el.textContent = msg; el.style.display = 'block';
    clearTimeout(toastTimer); toastTimer = setTimeout(()=>{ el.style.display='none' }, 2500);
  }

  function ch(s){ return s || ''; }

  // ————————————————————————————————————————————————————————
  // API helpers
  // ————————————————————————————————————————————————————————
  async function api(path, body){
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body||{})
    });
    if(!res.ok){
      const msg = await res.text().catch(()=>res.statusText);
      throw new Error('HTTP '+res.status+': '+msg);
    }
    return res.json();
  }

  // ————————————————————————————————————————————————————————
  // DOM elements
  // ————————————————————————————————————————————————————————
  const el = {
    tabJoin: $('tab-join'),
    tabCreate: $('tab-create'),
    paneJoin: $('pane-join'),
    paneCreate: $('pane-create'),

    nameJoin: $('name-join'),
    nameCreate: $('name-create'),
    joinCode: $('join-code'),
    btnJoin: $('btn-join'),
    btnCreate: $('btn-create'),

    how: $('how'),
    btnHow: $('btn-how'),

    lbList: $('lb-list'),
    btnLbRefresh: $('btn-lb-refresh'),

    lobbyCode: $('lobby-code'),
    roundNum: $('round-num'),
    players: $('players'),
    btnReady: $('btn-ready'),
    lobbyReady: $('lobby-ready-pill'),
    timerLobby: $('timer-lobby'),

    // Hint
    myRole: $('my-role'),
    themeHint: $('theme-hint-name'),
    myWord: $('my-word'),
    hintInstruction: $('hint-instruction'),
    hintInput: $('hint-input'),
    btnSendHint: $('btn-send-hint'),
    hintStatus: $('hint-status'),
    impostorTip: $('impostor-tip'),

    // Vote
    hints: $('hints'),
    voteButtons: $('vote-buttons'),
    themeVote: $('theme-vote-name'),

    // Result
    resDomain: $('res-domain'),
    resCommon: $('res-common'),
    resImp: $('res-imp'),
    resImpName: $('res-imp-name'),
    resVotes: $('res-votes'),
    btnNext: $('btn-next'),

    // Top scoreboard
    scoreBoard: $('scoreboard'),
    scoreList: $('score-list'),

    // timers and progress
    timerHints: $('timer-hints'),
    timerVote: $('timer-vote'),
    timerReveal: $('timer-reveal'),
    progressHints: $('progress-hints'),
    progressVote: $('progress-vote'),
    progressReady: $('progress-ready'),
  };

  function setActiveTab(tab){
    const isJoin = (tab==='join');
    el.tabJoin.setAttribute('aria-selected', isJoin? 'true':'false');
    el.tabCreate.setAttribute('aria-selected', !isJoin? 'true':'false');
    el.paneJoin.classList.toggle('active', isJoin);
    el.paneCreate.classList.toggle('active', !isJoin);
  }

  el.tabJoin.addEventListener('click', ()=> setActiveTab('join'));
  el.tabCreate.addEventListener('click', ()=> setActiveTab('create'));

  // How to play
  el.btnHow.addEventListener('click', ()=>{
    const s = getComputedStyle(el.how).display;
    el.how.style.display = (s==='none')? 'block':'none';
  });

  // Leaderboard
  async function refreshLB(){
    try{
      const data = await api('/lb', {});
      const list = (data?.top||[]).slice(0,50);
      el.lbList.innerHTML = list.length? list.map((p,i)=>{
        const tier = tierFromWins(p.wins||0);
        return `<div style="display:flex;align-items:center;gap:8px;justify-content:space-between;border-bottom:1px dashed #2a2135;padding:6px 0">
          <span style="display:flex;align-items:center;gap:8px">${svgTier(tier)}<b>#${i+1}</b> ${p.name||'???'}</span>
          <span>${p.wins||0} victoires</span>
        </div>`;
      }).join('') : '<em class="muted">Aucun résultat pour l\'instant.</em>';
    }catch(e){ el.lbList.textContent = 'Erreur: ' + e.message; }
  }
  $('btn-lb-refresh').addEventListener('click', refreshLB);
  refreshLB();

  // Create & Join
  function validateName(s){ return !!(s && /^[A-Za-zÀ-ÖØ-öø-ÿ0-9 _-]{2,16}$/.test(s)); }

  el.btnCreate.addEventListener('click', async ()=>{
    const name = el.nameCreate.value.trim();
    if(!validateName(name)) return toast('Nom invalide (2–16 car.)');
    try{
      const { room, player } = await api('/create', { name, dev: location.hostname==='localhost' });
      localStorage.setItem('hol-name', name);
      joinRoom(room.code, player.id);
    }catch(e){ toast('Erreur: '+e.message); }
  });

  el.btnJoin.addEventListener('click', async ()=>{
    const name = el.nameJoin.value.trim();
    if(!validateName(name)) return toast('Nom invalide (2–16 car.)');
    const code = (el.joinCode.value||'').trim();
    if(!code || code.length<ROOM_CODE_LEN) return toast('Code de salle invalide');
    try{
      const { player } = await api('/join', { code, name, dev: location.hostname==='localhost' });
      localStorage.setItem('hol-name', name);
      joinRoom(code, player.id);
    }catch(e){ toast('Erreur: '+e.message); }
  });

  function joinRoom(code, playerId){
    show('screen-lobby');
    el.lobbyCode.textContent = code;

    const payload = {
      code,
      playerId,
      name: localStorage.getItem('hol-name')||'???',
      device: getDeviceId(),
    };
    socket.emit('join-room', BYTES.encode(JSON.stringify(payload)));
  }

  // SOCKET EVENTS
  function parse(data){
    try{ return JSON.parse(DECODER.decode(data)); }
    catch(e){ return {}; }
  }

  socket.on('room-update', (data)=>{
    const msg = parse(data);
    if(!msg || !msg.type) return;

    if(msg.type==='lobby'){
      // players list
      const list = msg.players||[];
      const hostId = msg.hostId;
      const me = list.find(p=>p.isMe);
      el.players.innerHTML = '';
      list.forEach(p=>{
        const li = document.createElement('div');
        li.className = 'player';
        li.innerHTML = `<div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
          <span><b>${p.name}</b>${p.isMe?' <i class="muted">(moi)</i>':''}</span>
          <span class="muted">${p.ready? '✅ prêt':'⌛ attend'}</span>
        </div>`;
        el.players.appendChild(li);
      });

      if(me && msg.hostId===me.id){ $('host-badge').style.display='inline-block'; }
      el.roundNum.textContent = msg.round||0;
      el.lobbyReady.textContent = `${msg.ready||0}/${list.length} prêts`;

      // show start button only for host, when min players
      const canStart = msg.isHost && list.length>=3 && (msg.ready||0)>=Math.ceil(list.length*0.6);
      el.btnReady.textContent = canStart? 'Lancer la manche' : 'Je suis prêt';
      el.btnReady.dataset.role = canStart? 'start':'ready';
      el.btnReady.disabled = list.length<3;

      // scoreboard
      if(msg.top && msg.top.length){
        el.scoreBoard.style.display = 'block';
        el.scoreList.innerHTML = msg.top.map((p,i)=>`<li><span>#${i+1} ${p.name}</span><span>${p.wins||0} victoires</span></li>`).join('');
      }else{
        el.scoreBoard.style.display = 'none';
      }
    }

    if(msg.type==='phase'){
      if(msg.phase==='hint'){
        show('screen-hint');
        el.myRole.textContent = msg.isImp? 'Imposteur' : 'Équipier';
        el.myRole.classList.toggle('imp', !!msg.isImp);
        el.myRole.classList.toggle('crew', !msg.isImp);
        el.impostorTip.style.display = msg.isImp? 'block':'none';
        el.themeHint.textContent = msg.domain||'?';
        el.myWord.textContent = msg.word||'?';
        el.hintInstruction.style.display = msg.isImp? 'none':'block';
        el.hintInput.value = '';
        el.hintStatus.textContent = '';
        setTimer('hints', DUR.hints);
      }
      if(msg.phase==='vote'){
        show('screen-vote');
        el.themeVote.textContent = msg.domain||'?';
        el.hints.innerHTML = (msg.hints||[]).map(h=>`<p><b>${h.name}:</b> ${h.text}</p>`).join('');
        // vote buttons
        el.voteButtons.innerHTML = '';
        (msg.players||[]).forEach(p=>{
          const b = document.createElement('button');
          b.textContent = p.name;
          b.addEventListener('click', ()=>{
            document.querySelectorAll('#vote-buttons button').forEach(x=>x.classList.remove('selected'));
            b.classList.add('selected');
            socket.emit('vote', BYTES.encode(JSON.stringify({ id: p.id })));
          });
          el.voteButtons.appendChild(b);
        });
        setTimer('voting', DUR.voting);
      }
      if(msg.phase==='reveal'){
        show('screen-result');
        el.resDomain.textContent = msg.domain||'?';
        el.resCommon.textContent = ch(msg.common);
        el.resImp.textContent = ch(msg.imposter);
        el.resImpName.textContent = ch(msg.impName);
        el.resVotes.innerHTML = (msg.votes||[]).map(v=>`<div>${v.name} → <b>${v.vote}</b></div>`).join('');
        el.btnNext.style.display = msg.isHost? 'inline-block':'none';
        setTimer('reveal', 15000);

        const me = (msg.players||[]).find(p=>p.isMe);
        const win = me && ((me.isImp && msg.win==='impostor') || (!me.isImp && msg.win==='crew'));
        const banner = $('personal-banner');
        banner.textContent = win? 'GAGNÉ' : 'PERDU';
        banner.classList.toggle('result-win', !!win);
        banner.classList.toggle('result-lose', !win);
      }
    }

    if(msg.type==='progress'){
      if(typeof msg.done==='number' && typeof msg.total==='number'){
        const v = (msg.total? (msg.done/msg.total) : 0);
        document.querySelectorAll('.phase-bar').forEach(b=> b.style.setProperty('--progress', String(Math.max(0, Math.min(1, v)))));
        el.progressHints.textContent = `${msg.done}/${msg.total}`;
        el.progressVote.textContent = `${msg.done}/${msg.total}`;
      }
    }

    if(msg.type==='timer'){
      const t = String(msg.t||0).padStart(2,'0');
      if(msg.kind==='hints') el.timerHints.textContent = '00:'+t;
      if(msg.kind==='voting') el.timerVote.textContent = '00:'+t;
      if(msg.kind==='reveal') el.timerReveal.textContent = '00:'+t;
      if(msg.kind==='lobby') el.timerLobby.textContent = '00:'+t;
    }

    if(msg.type==='ready'){
      el.progressReady.textContent = `${msg.ready||0}/${msg.total||0} prêts`;
    }
  });

  function setTimer(kind, ms){
    const start = Date.now();
    update();
    function update(){
      const t = Math.max(0, ms - (Date.now()-start));
      const s = Math.ceil(t/1000);
      socket.emit('timer', BYTES.encode(JSON.stringify({ kind, t: s })));
      if(t>0) requestAnimationFrame(update);
    }
  }

  el.btnReady.addEventListener('click', ()=>{
    const role = el.btnReady.dataset.role||'ready';
    if(role==='start') socket.emit('start');
    else socket.emit('ready');
  });

  el.btnNext.addEventListener('click', ()=> socket.emit('next-round'));
  el.btnSendHint.addEventListener('click', ()=>{
    const text = (el.hintInput.value||'').trim();
    if(!text) return toast('Écris un indice');
    if(text.length>40) return toast('40 caractères max');
    socket.emit('hint', BYTES.encode(JSON.stringify({ text })));
    el.hintInput.value = '';
    el.hintStatus.textContent = 'Indice envoyé ✔';
  });

  // reconnect handling
  socket.on('connect', ()=>{
    const last = localStorage.getItem('hol-last');
    if(last){
      try{
        const s = JSON.parse(last);
        if(s.code && s.playerId){
          socket.emit('join-room', BYTES.encode(JSON.stringify(s)));
        }
      }catch(e){}
    }
  });

  socket.on('disconnect', ()=>{
    // show a toast
    toast('Connexion perdue. Reconnexion…');
  });

  // API to join room directly (for refresh)
  window.joinRoom = joinRoom;

  // Persist last room
  socket.on('joined', (data)=>{
    const msg = parse(data) || {};
    localStorage.setItem('hol-last', JSON.stringify({ code: msg.code, playerId: msg.playerId, name: msg.name, device: getDeviceId() }));
  });

  // Fill default name
  (function preset(){
    const saved = localStorage.getItem('hol-name')||'';
    if(saved){
      el.nameJoin.value = saved;
      el.nameCreate.value = saved;
    }
  })();

  // Keyboard enter to join
  ['name-join','join-code'].forEach(id=> $(id).addEventListener('keydown', (e)=>{
    if(e.key==='Enter') el.btnJoin.click();
  }));
  ['name-create'].forEach(id=> $(id).addEventListener('keydown', (e)=>{
    if(e.key==='Enter') el.btnCreate.click();
  }));

  // Copy lobby code (if needed)
  $('lobby-code').addEventListener('click', ()=>{
    const code = el.lobbyCode.textContent||'';
    if(code) copy(code);
  });

  // Debug show screens by URL ?screen=vote
  (function devScreens(){
    const p = new URLSearchParams(location.search);
    const s = p.get('screen'); if(!s) return;
    const id = 'screen-'+s;
    if(SCREENS.includes(id)) show(id);
  })();

  // Leaderboard refresh initially handled earlier

  // End of game script
  </script>

</body>
</html>
