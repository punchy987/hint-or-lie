<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hint or Lie · by Mits</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#070b14">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{
      color-scheme: dark;
      --bg: #070b14;
      --card: #0f1523;
      --line: #1b2436;
      --ink: #021125;
      --muted: #9fb0c5;
      --accent: #36bff8;
      --accent-2: #f43f5e;
      --accent-3: #22c55e;
      --glow: 0 0 0 rgba(0,0,0,0);
    }
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: radial-gradient(1000px 600px at 10% -10%, #0d1222 0%, transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, #0b1020 0%, transparent 60%),
                  var(--bg);
      color:var(--ink);
      overflow-y:auto;
    }
    .stars::before, .stars::after{
      content:""; position:fixed; inset:-20% -10% -10% -10%; pointer-events:none; z-index:-1;
      background-image: radial-gradient(#ffffff66 1px, transparent 1px);
      background-size: 3px 3px; opacity:.12; filter:drop-shadow(0 0 2px #ffffff33);
      animation: drift 160s linear infinite;
    }
    .stars::after{ opacity:.1; background-size: 2px 2px; animation-duration: 220s; }
    @keyframes drift{ from{ transform:translateY(0)} to{ transform:translateY(200px)} }

    .wrap{max-width:880px;margin:0 auto;padding:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--line); border-radius:20px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.35), var(--glow)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    h1,h2,h3,h4{margin:0 0 8px 0}

    input,button{width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    input::placeholder{color:#90a0b6}
    button{background:linear-gradient(180deg, #2AB7F6, #2AA2F6); border:none; font-weight:800; letter-spacing:.2px; cursor:pointer}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    .btn-secondary{background:#121a2b}

    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;display:inline-block}
    .role{font-weight:900;border:1px solid currentColor;border-radius:999px;padding:6px 12px;display:inline-block}
    .role.crew{color:var(--accent-3)}
    .role.imp{color:var(--accent-2)}
    .section-title{font-size:18px;margin:6px 0}
    .hint-word{font-size:34px;font-weight:900;letter-spacing:.3px;margin:4px 0 8px}

    /* Hero */
    .hero{display:flex;gap:16px;align-items:center; padding:16px 14px; border-radius:18px; background:linear-gradient(180deg, #0f172a, #0b1220); border:1px solid var(--line); box-shadow: inset 0 0 0 1px #0b1424}
    .hero h1{font-size:28px; letter-spacing:.3px}
    .hero svg{width:62px;height:62px; flex:0 0 62px; filter: drop-shadow(0 8px 18px rgba(54,191,248,.25));}

    /* Tabs home */
    .tabs{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:#0b1220}
    .tab-nav{display:flex}
    .tab-btn{flex:1;padding:12px 14px;border:0;background:transparent;color:#a9bed6;font-weight:700;cursor:pointer}
    .tab-btn[aria-selected="true"]{color:#0b1220;background:#2ab7f6;border-radius:12px;margin:6px;box-shadow:0 6px 16px rgba(42,183,246,.25)}
    .tab-pane{display:none;padding:14px}
    .tab-pane.active{display:block}

    /* Scoreboard */
    #scoreboard{max-width:880px;margin:16px auto 24px;background:#0b1220;border:1px solid var(--line);border-radius:16px;padding:12px; display:none}
    #scoreboard ul{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:1fr auto;row-gap:6px}
    #scoreboard li{display:contents}
    #scoreboard li span:last-child{justify-self:end;color:var(--muted)}

    /* Modal result */
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
    #modal .box{background:#0f1523;border:1px solid var(--line);border-radius:16px;padding:16px;max-width:360px}
    .result-banner{border:1px solid; border-radius:10px; padding:8px 12px; display:inline-block; margin:6px 0}
    .result-win{color:var(--accent-3);border-color:var(--accent-3)}
    .result-lose{color:var(--accent-2);border-color:var(--accent-2)}

    .rules{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:12px;background:#0b1220}
    .grid-votes{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}

    /* Vote — sélection visuelle */
    #vote-buttons button.selected{
      outline:2px solid #2ab7f6;
      box-shadow:0 0 4px rgba(42,183,246,.2);
    }
    #vote-buttons button{ position: relative; padding-right: 36px; }
    #vote-buttons button.selected::after{
      content:'✓';
      position:absolute;right:12px;top:50%;transform:translateY(-50%);font-weight:900;
    }

    /* ====== BARRE DE PHASE ====== */
    .phase-bar{
      display:grid;
      grid-template-columns: 1fr minmax(320px, 1.6fr) 1fr;
      align-items:center;
      gap:12px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:linear-gradient(180deg, #0f172a, #0b1220);
      box-shadow: inset 0 0 0 1px #0b1424;
      margin-bottom:10px;
    }
    .phase-left{ display:flex; align-items:center; gap:8px; }
    .phase-center{ display:flex; justify-content:center; }
    .phase-right{ display:flex; justify-content:flex-end; gap:10px; }

    .theme-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 14px; border-radius:999px;
      border:1px solid #2ab7f6; background:rgba(42,183,246,.08);
      box-shadow:0 8px 28px rgba(42,183,246,.08);
      font-weight:800;
    }
    .theme-chip b{
      color:#2ab7f6; font-weight:900; font-size:16px;
      text-transform:capitalize; /* pas de soulignement */
    }
    .kpi{
      min-width:66px; text-align:center;
      padding:6px 10px; border-radius:8px; border:1px solid var(--line);
      background:#0b1220; font-weight:700; color:#e6f2ff;
      box-shadow: inset 0 0 0 1px #0b1424;
    }

    /* Tip imposteur */
    .tip{
      margin: 8px 0 12px;
      padding: 8px 12px;
      background-color: rgba(255,230,150,.12);
      border: 1px solid rgba(255,230,150,.35);
      border-radius: 8px;
      color: #ffe696;
      font-size: .95rem;
      font-style: italic;
      display: none; /* affiché via JS quand imposteur */
    }

    /* ===== THEME UPGRADE — neon bluff vibes ===== */
    :root{
      --bg: #070b14;
      --card: #0f1523;
      --line: #1a2336;
      --ink: #e9f0fa;
      --muted: #9fb0c5;
      --accent: #2ab7f6;   /* équipiers (froid) */
      --accent-2: #f43f5e; /* imposteur (chaud) */
      --accent-3: #22c55e; /* succès */
      --glow: 0 0 40px rgba(42,183,246,.18);
    }
    body{
      background:
        radial-gradient(1200px 700px at -10% -10%, #0f1730 0%, transparent 60%),
        radial-gradient(1000px 600px at 110% -10%, #0c1328 0%, transparent 60%),
        var(--bg);
    }
    .card{
      border-radius: 20px;
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)),
        #0b1220;
      box-shadow: 0 24px 60px rgba(0,0,0,.40), var(--glow);
    }
    button{
      font-weight:800; letter-spacing:.2px; border:none;
      background: linear-gradient(180deg, #31c4ff, #2aa2f6);
      transition: transform .16s ease, box-shadow .2s ease, filter .2s ease;
      box-shadow: 0 6px 18px rgba(42,183,246,.25);
    }
    button:hover{ transform: translateY(-2px); filter:brightness(1.06); }
    button:active{ transform: translateY(0); }
    .btn-secondary{
      background: #121a2b; border:1px solid var(--line); font-weight:700;
    }
    input,button{ border-radius: 14px; }
    .role{ font-weight:900; letter-spacing:.3px; }
    .role.crew{ color: var(--accent-3); border-color: var(--accent-3); }
    .role.imp{ color: var(--accent-2); border-color: var(--accent-2); }
    .theme-chip{
      border:1px solid rgba(42,183,246,.55);
      background: linear-gradient(180deg, rgba(42,183,246,.12), rgba(42,183,246,.06));
      box-shadow: 0 10px 28px rgba(42,183,246,.14);
    }
    .theme-chip b{ color:#79d8ff; }
    .phase-bar{
      position:relative;
      z-index: 0;
      overflow:hidden;
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid #0f1930;
      box-shadow: inset 0 0 0 1px #0b1424, 0 10px 26px rgba(0,0,0,.35);
    }
    .phase-bar::after{
      content:"";
      position:absolute; left:0; top:0; bottom:0;
      width:100%;
      transform-origin: left center;
      transform: scaleX(var(--progress, 0)); /* 0→1 */
      background: linear-gradient(90deg, rgba(42,183,246,.25), rgba(244,63,94,.25));
      filter: saturate(110%);
      z-index: -1;
      pointer-events:none;
      /* transition enlevée pour éviter les à-coups, anim gérée en JS */
      transition: none;
      mix-blend-mode: screen;
    }
    .kpi{
      border:1px solid rgba(125,170,255,.18);
      background: #0a1120;
      box-shadow: inset 0 0 0 1px #0b1424;
    }
    #hints p{ padding:8px 10px; border-radius:10px; background:#0b1220; border:1px solid var(--line); }
    #vote-buttons button{
      background:#0b1220; border:1px solid var(--line);
      text-align:left; padding-right:40px;
    }
    #vote-buttons button:hover{ box-shadow: 0 0 10px rgba(42,183,246,.18); }
    #vote-buttons button.selected{
      outline:2px solid #2ab7f6;
      box-shadow: 0 0 14px rgba(42,183,246,.25);
    }
    .result-banner{ font-weight:800; background:#0b1220; }
    .result-win{
      color: var(--accent-3);
      border-color: rgba(34,197,94,.8);
      box-shadow: 0 0 20px rgba(34,197,94,.25);
    }
    .result-lose{
      color: var(--accent-2);
      border-color: rgba(244,63,94,.8);
      box-shadow: 0 0 20px rgba(244,63,94,.25);
    }
    .tip{
      background: linear-gradient(180deg, rgba(255,230,150,.12), rgba(255,230,150,.08));
      border: 1px solid rgba(255,230,150,.35);
      box-shadow: 0 10px 24px rgba(255,230,150,.08);
    }
    #scoreboard{
      display:none; /* géré par le JS */
      border:1px solid var(--line);
      background:#0b1220;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      border-radius:16px;
    }
    #scoreboard li span:first-child{ font-weight:700; }
  
/* === Signature badge (by Mits) === */
.title-line{
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
}
.signature-badge{
  font-size:13px; font-weight:800; letter-spacing:.2px;
  color:var(--ink); opacity:.9;
  padding:4px 10px; border-radius:999px;
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(42,183,246,.12), rgba(42,183,246,.06));
  box-shadow: 0 6px 16px rgba(42,183,246,.12);
}
.signature-badge::before{
  content:'✦'; margin-right:6px; opacity:.9;
}
@media (max-width:560px){
  .title-line{ flex-direction:column; align-items:flex-start; gap:6px; }
}


/* === Responsive mobile overhaul (<= 600px) === */
@media (max-width: 600px){
  :root{ --glow: 0 0 20px rgba(42,183,246,.12); }
  html, body { overscroll-behavior-y: contain; }
  .wrap{ max-width: 100%; padding: 10px; }
  .card{ padding: 12px; border-radius: 14px; }
  .row{ flex-direction: column; align-items: stretch; gap: 8px; }
  .hero{ flex-direction: row; gap: 10px; padding: 12px; }
  .hero svg{ width: 46px; height: 46px; flex: 0 0 46px; }
  .hero h1{ font-size: 22px; }
  .muted{ font-size: 14px; }
  h3.section-title{ font-size: 16px; }
  .hint-word{ font-size: 24px; word-break: break-word; }
  input, button{ padding: 12px; font-size: 15px; min-height: 44px; }
  .btn-secondary{ font-weight: 700; }
  .tabs{ margin-top: 10px; }
  .tab-btn{ padding: 10px 12px; font-size: 14px; }
  .tab-btn[aria-selected="true"]{ margin: 6px; }
  .tab-pane{ padding: 10px; }
  /* Phase bar becomes single column centered */
  .phase-bar{
    grid-template-columns: 1fr;
    gap: 6px;
    text-align: center;
    padding: 8px 10px;
  }
  .phase-left, .phase-center, .phase-right{
    justify-content: center;
  }
  .kpi{ min-width: auto; padding: 6px 8px; font-size: 14px; }
  .theme-chip{ padding: 6px 10px; gap: 6px; }
  .theme-chip b{ font-size: 15px; }
  /* Hints and vote */
  #hints p{ padding: 8px 10px; font-size: 15px; }
  .grid-votes{ grid-template-columns: 1fr; gap: 8px; }
  #vote-buttons button{ padding-right: 38px; font-size: 15px; }
  /* Lobby list items */
  #players .player, #players div{ padding: 8px 10px; border-radius: 10px; background:#0b1220; border:1px solid var(--line); }
  /* Leaderboard inside home */
  #lb{ padding: 10px; }
  #scoreboard{ position: static; margin: 12px 10px 18px; padding: 10px; }
  #scoreboard ul{ grid-template-columns: 1fr auto; row-gap: 6px; }
  #scoreboard li span:first-child{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  /* Pills & badges */
  .pill{ padding: 5px 8px; font-size: 13px; }
  .role{ padding: 6px 10px; font-size: 13px; }
  .signature-badge{ font-size: 12px; padding: 4px 8px; }
  /* Modal */
  #modal .box{ max-width: 92vw; width: 92vw; padding: 14px; }
}

/* Extra-small phones (<= 380px) */
@media (max-width: 380px){
  .hero{ flex-direction: column; align-items: flex-start; }
  .hero svg{ width: 40px; height: 40px; }
  .hero h1{ font-size: 20px; }
  .tab-nav{ flex-direction: column; }
  .tab-btn[aria-selected="true"]{ margin: 6px; border-radius: 10px; }
  .hint-word{ font-size: 22px; }
  .theme-chip b{ font-size: 14px; }
  #hints p{ font-size: 14px; }
  #vote-buttons button{ font-size: 14px; }
}

/* Touch optimizations */
@media (hover: none){
  button:active{ transform: translateY(1px); }
  input, button{ -webkit-tap-highlight-color: transparent; }
}

/* ===== Palmarès #lb (densification mobile) ===== */
@media (max-width: 600px){
  /* Palmarès Top 50 (pane Accueil) */
  #lb{ padding: 10px; }
  #lb-list ul{ row-gap: 4px; }
  #lb-list li{ padding: 4px 0; }
  #lb-list li span:first-child{ min-width: 28px; text-align: right; }
  #lb-list li span:nth-child(2){
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  /* On cache le badge de palier pour gagner de la place */
  #lb-list .pill{ display: none; }

  /* Scoreboard repliable */
  #scoreboard{ padding: 10px; }
  #scoreboard ul{ row-gap: 6px; }
  #scoreboard li{ padding: 4px 0; }
}
/* === Fix: le chip thème ne coupe plus le texte === */
.phase-left, .phase-center, .phase-right { min-width: 0; }

.theme-chip{
  display: flex;           /* au lieu de inline-flex pour autoriser double ligne */
  max-width: 100%;
  flex-wrap: wrap;         /* autorise le retour à la ligne */
  justify-content: center; /* reste centré */
}

.theme-chip b{
  white-space: normal;     /* autorise la casse */
  word-break: break-word;  /* casse un mot long si besoin */
  overflow-wrap: anywhere; /* force un wrap si rien d’autre ne marche */
}

@media (max-width:600px){
  .theme-chip{ padding: 6px 10px; gap: 6px; }
  .theme-chip b{ font-size: 14px; }
}
#btn-install{
  position: sticky; top: 0; z-index: 1000;
  width: 100%; border-radius: 0;
  padding: 12px 16px; font-weight: 800;
  }
</style>
</head>
<body class="stars">

<!-- MODAL GAME OVER -->
<div id="modal">
  <div class="box">
    <h3>Vainqueur 🎉</h3>
    <p id="winners-text"></p>
    <div class="row">
      <button id="btn-modal-lobby">Retour au salon</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HOME -->
  <div class="card" id="screen-home">
    <div class="hero">
      <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M92 102c0 6-5 11-11 11H39a11 11 0 0 1-11-11V58a33 33 0 0 1 33-33h9a33 33 0 0 1 33 33v23c0 6-5 11-11 11h-2z" fill="#1c2742"/>
        <rect x="74" y="68" width="26" height="20" rx="10" fill="#303b66"/>
        <rect x="20" y="64" width="20" height="38" rx="10" fill="#1c2742"/>
        <rect x="42" y="28" width="56" height="28" rx="14" fill="#31b2f3"/>
        <rect x="50" y="34" width="34" height="16" rx="8" fill="#7fd7ff"/>
      </svg>
      <div>
        <div class="title-line">
        <h1>Hint or Lie</h1>
        <span class="signature-badge" title="Créé par Mits">by Mits</span>
      </div>
        <div class="muted"><strong>Chaque indice compte.</strong> Bluffez, suspectez, et attrapez l’intrus.</div>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Actions">
      <div class="tab-nav">
        <button class="tab-btn" id="tab-join" role="tab" aria-controls="pane-join" aria-selected="true">Rejoindre</button>
        <button class="tab-btn" id="tab-create" role="tab" aria-controls="pane-create" aria-selected="false">Créer</button>
      </div>
      <div id="pane-join" class="tab-pane active" role="tabpanel" aria-labelledby="tab-join">
        <div class="row" style="align-items:flex-end">
          <input id="name-join" placeholder="Ton pseudo" maxlength="16" />
          <input id="join-code" placeholder="Code salle" maxlength="6" />
          <button id="btn-join">Rejoindre</button>
        </div>
        <p class="muted" style="text-align:right;margin:6px 2px 0 0">Code de salle ex : <code>4831</code></p>
      </div>
      <div id="pane-create" class="tab-pane" role="tabpanel" aria-labelledby="tab-create">
        <div class="row" style="align-items:flex-end">
          <input id="name-create" placeholder="Ton pseudo" maxlength="16" />
          <button id="btn-create">Créer une salle</button>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>

    <button class="btn-secondary" id="btn-how" type="button">Règles rapides</button>
    <div id="how" class="rules" style="display:none">
      <h4>Règles — en 4 points</h4>
      <ul>
        <li>La plupart ont le <strong>même mot</strong>, un joueur a un <strong>mot différent</strong> (imposteur).</li>
        <li><strong>Indice :</strong> chacun donne <strong>1 mot</strong> lié au thème, sans le révéler.</li>
        <li><strong>Vote :</strong> on choisit le suspect, puis révélation et points.</li>
        <li><strong>Victoire :</strong> premier à <strong>10 points</strong>.</li>
      </ul>
    </div>
    <div class="rules" id="lb" style="margin-top:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h4 style="margin:0">Palmarès — Top 50</h4>
        <button class="btn-secondary" id="btn-lb-refresh" type="button">Actualiser</button>
      </div>
      <div id="lb-list" class="muted" style="margin-top:8px">Chargement…</div>
    </div>

  </div>

  <!-- LOBBY -->
  <div class="card" id="screen-lobby" style="display:none">
    <div class="row">
      <div class="pill" id="host-badge" style="display:none">Tu es l'hôte</div>
      <div class="pill">Manche <span id="round-num">0</span></div>
      <div class="pill">Code <span id="lobby-code"></span></div>
      <div class="pill" id="lobby-ready-pill">0/0 prêts</div>
      <div class="pill" id="timer-lobby" style="display:none">00:10</div>
    </div>

    <h3 class="section-title">Joueurs</h3>
    <div id="players" class="list" style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:8px"></div>

    <div class="row" id="lobby-actions">
      <button id="btn-ready">Je suis prêt</button>
    </div>

    <div class="rules">
      <h4>Règles — Hint or Lie</h4>
      <ul>
        <li>La plupart ont le <strong>même mot</strong>, un joueur a un <strong>mot différent</strong> (imposteur).</li>
        <li><strong>Indice :</strong> chacun donne 1 mot lié au thème, sans révéler le mot.</li>
        <li><strong>Vote :</strong> on choisit le suspect. Révélation & points.</li>
        <li><strong>Victoire :</strong> premier à <strong>10 points</strong>.</li>
      </ul>
    </div>
  </div>

  <!-- HINT -->
  <div class="card" id="screen-hint" style="display:none">
    <div class="phase-bar">
      <div class="phase-left">
        <span id="my-role" class="role">Rôle</span>
      </div>
      <div class="phase-center">
        <span class="theme-chip">📌 Thème : <b id="theme-hint-name">?</b></span>
      </div>
      <div class="phase-right">
        <span class="kpi" id="timer-hints">00:45</span>
        <span class="kpi" id="progress-hints">0/0</span>
      </div>
    </div>

    <div id="impostor-tip" class="tip">
      🎭 <em>Même thème, autre mot. Fais croire que tu es l’un d’eux.</em>
    </div>

    <h3 class="section-title">Ton mot</h3>
    <div id="my-word" class="hint-word">?</div>
    <p class="muted" id="hint-instruction" style="margin-top:6px">Donne 1 mot lié au thème sans le révéler. 📌</p>
    <input id="hint-input" placeholder="Ton indice" maxlength="40" />
    <div class="row"><button id="btn-send-hint">Envoyer l'indice</button></div>
    <p class="muted" id="hint-status"></p>
  </div>

  <!-- VOTE -->
  <div class="card" id="screen-vote" style="display:none">
    <div class="phase-bar">
      <div class="phase-left"></div>
      <div class="phase-center">
        <span class="theme-chip">📌 Thème : <b id="theme-vote-name">?</b></span>
      </div>
      <div class="phase-right">
        <span class="kpi" id="timer-vote">00:40</span>
        <span class="kpi" id="progress-vote">0/0</span>
      </div>
    </div>

    <h3 class="section-title">Vote</h3>
    <p class="muted" style="margin-bottom:8px">Lis les indices puis choisis le suspect.</p>
    <div id="hints" style="margin:8px 0"></div>
    <div id="vote-buttons" class="grid-votes"></div>
  </div>

  <!-- RESULT -->
  <div class="card" id="screen-result" style="display:none">
    <div class="phase-bar">
      <div class="phase-left"></div>
      <div class="phase-center">
        <span class="theme-chip">📌 Thème : <b id="res-domain">?</b></span>
      </div>
      <div class="phase-right">
        <span class="kpi" id="timer-reveal">--:--</span>
        <span class="kpi" id="progress-ready">0/0 prêts</span>
      </div>
    </div>

    <div id="personal-banner" class="result-banner">Résultat</div>
    <h3 class="section-title">Résumé</h3>
    <p>Mot commun : <strong id="res-common"></strong> — Mot imposteur : <strong id="res-imp"></strong></p>
    <p>Imposteur : <strong id="res-imp-name"></strong></p>
    <div id="res-votes" style="margin:8px 0"></div>
    <div class="row"><button id="btn-next" style="display:none">Manche suivante</button></div>
  </div>
</div>

<!-- SCOREBOARD -->
<div id="scoreboard">
  <h4>Scores</h4>
  <ul id="score-list"></ul>
</div>


<p class="muted" id="toast" style="display:none;text-align:center"></p>

<script>
  const $ = (id) => document.getElementById(id);
  const socket = io();
  function getDeviceId(){
    const k='hol_device'; let id = localStorage.getItem(k);
    if(!id){ id = 'd-' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k,id); }
    return id;
  }

  function tierFromWins(w){
    if (w>=120) return 'Diamond';
    if (w>=60)  return 'Platinum';
    if (w>=25)  return 'Gold';
    if (w>=10)  return 'Silver';
    return 'Bronze';
  }

  function renderLeaderboard(items){
    const meId = getDeviceId();
    if (!Array.isArray(items) || !items.length){
      $('lb-list').innerHTML = '<span class="muted">Aucun résultat pour l’instant.</span>';
      return;
    }
    const frag = document.createDocumentFragment();
    const ul = document.createElement('ul');
    ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
    items.forEach((x, i)=>{
      const li = document.createElement('li');
      const meMark = x.deviceId===meId ? ' (toi)' : '';
      const tier = tierFromWins(x.wins||0);
      li.style.display='grid';
      li.style.gridTemplateColumns='minmax(24px,40px) 1fr auto';
      li.style.gap='8px';
      li.style.padding='6px 0';
      li.innerHTML = `<span>#${i+1}</span>
        <span><strong>${x.pseudo||'Joueur'}</strong> <span class="pill" style="margin-left:6px">${tier}</span>${meMark}</span>
        <span class="muted">${x.wins||0} victoires</span>`;
      ul.appendChild(li);
    });
    frag.appendChild(ul);
    const box = $('lb-list'); if (box){ box.innerHTML=''; box.appendChild(frag); }
  }

// ===== Leaderboard: spinner + cooldown + auto-refresh =====
function requestLeaderboard(){ socket.emit('getLeaderboard'); }

(function setupLeaderboardUI(){
  const btn = $('btn-lb-refresh');
  if (!btn) return;
  const original = btn.textContent;
  let refreshing = false;

  // (ré)abonne le listener proprement
  const onData = (items)=>{
    renderLeaderboard(items);
    if (refreshing){
      refreshing = false;
      btn.disabled = false;
      btn.textContent = original;
    }
  };
  if (socket.off) socket.off('leaderboardData', onData);
  socket.on('leaderboardData', onData);

  // Bouton "Actualiser" avec spinner + petit cooldown
  btn.onclick = ()=>{
    if (refreshing) return;
    refreshing = true;
    btn.disabled = true;
    btn.textContent = '...';
    requestLeaderboard();
    // filet de sécu si le serveur tarde
    setTimeout(()=>{
      if (refreshing){
        refreshing = false;
        btn.disabled = false;
        btn.textContent = original;
      }
    }, 1500);
  };

  // Auto-refresh discret toutes les 45s quand l’onglet est visible
  let timer = null;
  const start = ()=>{
    if (!timer){
      requestLeaderboard();           // ping immédiat
      timer = setInterval(requestLeaderboard, 45000);
    }
  };
  const stop = ()=>{ if (timer){ clearInterval(timer); timer = null; } };

  document.addEventListener('visibilitychange', ()=> document.hidden ? stop() : start());
  socket.on('connect', start);
  start();
})();

  let me = { id: null, code: null };
  let room = { players: [], state: 'lobby' };
  let myIsImpostor = false;
  let myLobbyReady = false;

  /* ===== Barre de progression fluide (RAF) ===== */
  const DUR = { hints: 45_000, voting: 40_000, prestart: 3_000 };
  let lobbyTotalMs = 0;
  let currentPhase = null;   // reset bip quand la phase change
  // Anti-double bip même si le serveur tick 2x/seconde
  let lastBeepSec = null;
  let lastBeepAt = 0;
  let phaseChangeAt = 0;

  function safeBeepOncePerSecond(leftMs){
  const now = Date.now();

  // Ignore les 200 ms qui suivent un changement de phase
  if (now - phaseChangeAt < 200) return;

  // Convertit en secondes avec arrondi à la seconde la plus proche
  const sec = Math.round(leftMs / 1000);

  // Ne bippe que pour 3, 2, 1
  if (sec >= 1 && sec <= 3) {
    // Tolérance : au moins 700 ms entre deux bips
    if (now - lastBeepAt >= 700 && sec !== lastBeepSec) {
      beep();
      lastBeepSec = sec;
      lastBeepAt = now;
    }
  } else {
    lastBeepSec = null; // reset hors 3,2,1
  }
}

  const phaseAnim = { phase:null, deadline:0, total:0, raf:null };
  function stopPhaseAnim(){
    if (phaseAnim.raf) cancelAnimationFrame(phaseAnim.raf);
    phaseAnim.raf = null;
  }
  function phaseScope(phase){
    if (phase === 'hints')   return document.querySelector('#screen-hint .phase-bar');
    if (phase === 'voting')  return document.querySelector('#screen-vote .phase-bar');
    if (phase === 'prestart')return document.querySelector('#screen-result .phase-bar');
    if (phase === 'lobby')   return document.querySelector('#screen-lobby .phase-bar');
    return null;
  }
  function tickPhase(){
    const el = phaseScope(phaseAnim.phase);
    if (!el) return;
    const left = Math.max(0, phaseAnim.deadline - Date.now());
    const pct = Math.max(0, Math.min(1, 1 - (left / phaseAnim.total)));
    el.style.setProperty('--progress', pct.toFixed(4));
    if (pct < 1 && phaseAnim.phase) phaseAnim.raf = requestAnimationFrame(tickPhase);
  }
  function startPhaseAnim(phase, totalMs, leftMs){
    if (!phase || !totalMs) return;
    phaseAnim.phase = phase;
    phaseAnim.total = totalMs;
    phaseAnim.deadline = Date.now() + (leftMs ?? totalMs);
    stopPhaseAnim();
    phaseAnim.raf = requestAnimationFrame(tickPhase);
  }
  function resetPhaseProgress(){
    document.querySelectorAll('.phase-bar').forEach(el=> el.style.setProperty('--progress','0'));
    stopPhaseAnim();
  }

  /* Helpers UI */
  function show(id){
    for(const el of document.querySelectorAll('.card')) el.style.display='none';
    $(id).style.display='block';
    const sb=$('scoreboard'); if(sb) sb.style.display = (id==='screen-home') ? 'none' : 'block';
    document.body.setAttribute('data-screen', id);
  }
  function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
  function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
function beep(){
  if (typeof SOUND_ENABLED === 'undefined' || !SOUND_ENABLED) return; // son coupé
  // TODO : jouer un son si tu veux plus tard
}
function flash(id){
  const el = document.getElementById(id); if(!el) return;
  el.style.outline='2px solid #ef4444'; setTimeout(()=>el.style.outline='',150);
}
  function updateScoreboard(players){
    const ul=$('score-list'); if(!players||!ul) return;
    ul.innerHTML='';
    players.slice().sort((a,b)=>b.score-a.score).forEach(p=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${p.name}</span><span>${p.score}</span>`;
      ul.appendChild(li);
    });
  }

  /* Tabs */
  const tabs = { join: $('tab-join'), create: $('tab-create') };
  const panes = { join: $('pane-join'), create: $('pane-create') };
  function activateTab(which){
    const isJoin = which === 'join';
    tabs.join.setAttribute('aria-selected', isJoin ? 'true' : 'false');
    tabs.create.setAttribute('aria-selected', isJoin ? 'false' : 'true');
    panes.join.classList.toggle('active', isJoin);
    panes.create.classList.toggle('active', !isJoin);
    (isJoin ? $('name-join') : $('name-create'))?.focus();
  }
  tabs.join.addEventListener('click', ()=>activateTab('join'));
  tabs.create.addEventListener('click', ()=>activateTab('create'));

  /* Filtre code: chiffres, 4 max */
  $('join-code')?.addEventListener('input', e=>{
    e.target.value = e.target.value.replace(/\D/g,'').slice(0,4);
  });

  /* Home actions */
  $('btn-join').onclick=()=>{
    const name = $('name-join')?.value.trim() || 'Joueur';
    const code = $('join-code')?.value.trim();
    const deviceId = getDeviceId(); socket.emit('hello', { deviceId, pseudo: name }); socket.emit('joinRoom',{code,name,deviceId});
  };
  $('btn-create').onclick=()=>{
    const name=$('name-create')?.value.trim()||'Joueur';
    const deviceId = getDeviceId(); socket.emit('hello', { deviceId, pseudo: name }); socket.emit('createRoom',{name,deviceId});
  };

  /* Toggle règles */
  $('btn-how').addEventListener('click', ()=>{
    const panel = $('how');
    const visible = panel.style.display !== 'none';
    panel.style.display = visible ? 'none' : 'block';
    $('btn-how').textContent = visible ? 'Règles rapides' : 'Masquer les règles';
  });

  /* Lobby */
  $('btn-ready').onclick=()=>{
    myLobbyReady = !myLobbyReady;
    $('btn-ready').textContent = myLobbyReady ? 'Annuler prêt' : 'Je suis prêt';
    socket.emit('playerReadyLobby', { ready: myLobbyReady });
  };
  $('btn-next').onclick=()=>{
    $('btn-next').disabled = true;
    $('btn-next').textContent = 'Prêt ✓';
    socket.emit('playerReadyNext');
  };
  $('btn-modal-lobby').onclick=()=>{ show('screen-lobby'); $('modal').style.display='none'; };

  /* Hint submit */
  $('btn-send-hint').onclick=()=>{
    const hint=$('hint-input').value.trim();
    if(!hint){ toast('Écris un indice 😉'); return; }
    socket.emit('submitHint',{hint});
    $('btn-send-hint').disabled=true;
    $('hint-input').disabled=true;
    $('hint-status').textContent="Indice envoyé…";
  };

  /* Socket events */
  socket.on('connect',()=>{
    socket.emit('getLeaderboard');
 me.id=socket.id; });

  socket.on('roomCreated',({code})=>{
    me.code=code;
    $('lobby-code').textContent=code;
    show('screen-lobby');
    $('host-badge').style.display='inline-block';
    myLobbyReady = false;
    $('btn-ready').textContent = 'Je suis prêt';
    $('timer-lobby').style.display='none';
  });

  socket.on('roomJoined',({code})=>{
    me.code=code;
    $('lobby-code').textContent=code;
    show('screen-lobby');
    myLobbyReady = false;
    $('btn-ready').textContent = 'Je suis prêt';
    $('timer-lobby').style.display='none';
  });

  socket.on('roomUpdate',(snap)=>{
    room=snap; $('round-num').textContent=snap.round;
    const list=$('players'); list.innerHTML='';
    snap.players.forEach(p=>{
      const a=document.createElement('div'); a.textContent = p.name;
      list.appendChild(a);
    });
    updateScoreboard(snap.players);
  });

  socket.on('lobbyReadyProgress', ({ ready, total })=>{
    const pill = $('lobby-ready-pill'); if (pill) pill.textContent = `${ready}/${total} prêts`;
  });
  socket.on('lobbyCountdownStarted', ({ seconds })=>{
    $('timer-lobby').style.display='inline-block';
    toast(`Tout le monde est prêt ! Départ dans ${seconds}s…`);
    lobbyTotalMs = seconds * 1000;
    resetPhaseProgress();
  });
  socket.on('lobbyCountdownCancelled', ()=>{
    $('timer-lobby').style.display='none';
    if (myLobbyReady) {
      myLobbyReady = false;
      $('btn-ready').textContent = 'Je suis prêt';
    }
    toast('Un joueur a rejoint. Décompte annulé, remettez-vous prêts.');
    lobbyTotalMs = 0;
    resetPhaseProgress();
  });

  /* PHASE INDICES */
  socket.on('roundInfo',({word,isImpostor,domain})=>{
    myIsImpostor = !!isImpostor;
    show('screen-hint');
    resetPhaseProgress();

    $('theme-hint-name').textContent = domain || '?';
    const roleEl=$('my-role');
    roleEl.textContent=isImpostor?'Tu es IMPOSTEUR':'Tu es Équipier';
    roleEl.className='role '+(isImpostor?'imp':'crew');

    const tip = $('impostor-tip');
    if (tip) tip.style.display = isImpostor ? 'block' : 'none';

    $('hint-instruction').textContent = isImpostor
      ? "Donne 1 mot qui pourrait coller au thème. 📌"
      : "Donne 1 mot lié au thème sans le révéler. 📌";
    $('my-word').textContent=word;

    $('hint-input').value=''; $('hint-input').disabled=false;
    $('btn-send-hint').disabled=false; $('hint-status').textContent='';
    $('timer-vote').textContent='00:40';
    $('progress-hints').textContent='0/0';
    $('progress-vote').textContent='0/0';
    $('timer-reveal').textContent='--:--';
  });
  socket.on('hintAck', ()=>{ $('hint-status').textContent="Indice accepté ✓"; });
  socket.on('hintRejected', ({reason})=>{
    $('hint-status').textContent = `Refusé : ${reason}`;
    $('btn-send-hint').disabled=false;
    $('hint-input').disabled=false;
    $('hint-input').focus();
  });

  /* PHASE VOTE */
  socket.on('allHints', ({hints, domain})=>{
    show('screen-vote');
    $('theme-vote-name').textContent = domain || '?';
    resetPhaseProgress();

    const box = $('hints'); 
    box.innerHTML = '';
    hints.forEach(h=>{
      const p = document.createElement('p');
      p.innerHTML = `<strong>${h.name}</strong> : ${h.hint || ''}`;
      box.appendChild(p);
    });

    const cont = $('vote-buttons');
    cont.innerHTML = '';
    let selectedId = null;
    const renderSelection = ()=>{
      Array.from(cont.querySelectorAll('button')).forEach(b=>{
        const sel = b.dataset.id === selectedId;
        b.classList.toggle('selected', sel);
        b.setAttribute('aria-pressed', sel ? 'true' : 'false');
      });
    };

    hints.forEach(h=>{
      const btn = document.createElement('button');
      btn.textContent = h.name;
      btn.dataset.id = h.id;
      btn.setAttribute('aria-pressed','false');
      btn.onclick = ()=>{
        selectedId = h.id;
        renderSelection();
        socket.emit('submitVote', { targetId: h.id });
        toast('Vote envoyé (modifiable)');
      };
      cont.appendChild(btn);
    });
  });

  /* ENTER helpers */
  function onEnter(id, handler){
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); handler(); }
    });
  }
  onEnter('name-join', ()=> document.getElementById('btn-join')?.click());
  onEnter('join-code', ()=> document.getElementById('btn-join')?.click());
  onEnter('name-create', ()=> document.getElementById('btn-create')?.click());
  onEnter('hint-input', ()=>{
    const btn = document.getElementById('btn-send-hint');
    const val = document.getElementById('hint-input')?.value.trim();
    if(btn && !btn.disabled && val) btn.click();
  });

  /* ENTER global */
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Enter') return;
    const ae = document.activeElement;
    const typing = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
    if(typing) return;

    const screen = document.body.getAttribute('data-screen');

    if(screen === 'screen-lobby'){
      const b = document.getElementById('btn-ready');
      if(b){ e.preventDefault(); b.click(); }
    } else if(screen === 'screen-result'){
      const b = document.getElementById('btn-next');
      if(b && b.style.display !== 'none' && !b.disabled){ e.preventDefault(); b.click(); }
    } else if(screen === 'screen-home'){
      const joinPaneActive = document.getElementById('pane-join')?.classList.contains('active');
      const primary = joinPaneActive ? document.getElementById('btn-join') : document.getElementById('btn-create');
      if(primary){ e.preventDefault(); primary.click(); }
    } else if(screen === 'screen-vote'){
      const btn = document.querySelector('#vote-buttons button:not(:disabled)');
      if(btn){ e.preventDefault(); btn.click(); }
    }
  });

  /* PROGRESS + LOCK */
  socket.on('phaseProgress', ({ phase, submitted, total }) => {
    if (phase === 'hints') {
      const el = $('progress-hints'); if (el) el.textContent = `${submitted}/${total}`;
    } else if (phase === 'voting') {
      const el = $('progress-vote'); if (el) el.textContent = `${submitted}/${total}`;
      if (submitted === total) {
        const cont = $('vote-buttons');
        if (cont) Array.from(cont.querySelectorAll('button')).forEach(b => b.disabled = true);
      }
    }
  });

  /* Timers */
socket.on('timer', ({ phase, leftMs })=>{
  // 1) Reset anti-double bip dès changement de phase (typo fixée + reset complet)
  if (phase !== currentPhase) {
    currentPhase = phase;
    lastBeepSec = null;     // (pas lastBipSecond)
    lastBeepAt = 0;
    phaseChangeAt = Date.now();
  }

  // 2) Barre fluide (inchangé)
  const totalFor = (ph)=> ph==='hints'?DUR.hints
                        : ph==='voting'?DUR.voting
                        : ph==='prestart'?DUR.prestart
                        : ph==='lobby'?lobbyTotalMs : 0;
  startPhaseAnim(phase, totalFor(phase), leftMs);

  // 3) Secondes affichées (stable)
  const left = Math.floor((leftMs + 20) / 1000);

  // 4) Phases
  if (phase === 'hints') {
    const el = $('timer-hints'); if (el) el.textContent = fmt(leftMs);
    if (left > 0 && left <= 3) { flash('timer-hints'); }
    safeBeepOncePerSecond(leftMs);
    if (left <= 0) { $('btn-send-hint')?.setAttribute('disabled','true'); $('hint-input')?.setAttribute('disabled','true'); }

  } else if (phase === 'voting') {
    const el = $('timer-vote'); if (el) el.textContent = fmt(leftMs);
    if (left > 0 && left <= 3) { flash('timer-vote'); }            // <- bon id
    safeBeepOncePerSecond(leftMs);

    if (left <= 0) {
      const cont = $('vote-buttons') || document.createElement('div');
      Array.from(cont.querySelectorAll('button')).forEach(b => b.disabled = true);
    }

  } else if (phase === 'prestart') {
    const el = $('timer-reveal'); if (el) el.textContent = fmt(leftMs);
    if (left > 0 && left <= 3) { flash('timer-reveal'); }          // <- bon id
    safeBeepOncePerSecond(leftMs);

  } else if (phase === 'lobby') {
    const el = $('timer-lobby');
    if (el) {
      el.style.display = 'inline-block';
      el.textContent = fmt(leftMs);
      if (left <= 0) el.style.display = 'none';
    }
    if (left > 0 && left <= 3) { flash('timer-lobby'); }           // <- bon id
    safeBeepOncePerSecond(leftMs);
  }
});

  /* RESULT */
  socket.on('roundResult',(res)=>{
    show('screen-result');

    $('res-domain').textContent=res.domain||'?';
    $('res-common').textContent=res.common;
    $('res-imp').textContent=res.impostor;
    $('res-imp-name').textContent=res.impostorName||'(?)';

    let win=false, text='';
    if (myIsImpostor){ win=!res.impostorCaught; text=win?'GAGNÉ ✅ Tu es resté discret.':'PERDU ❌ Tu as été repéré.'; }
    else { win=res.impostorCaught; text=win?'GAGNÉ ✅ L’imposteur a été démasqué.':'PERDU ❌ L’imposteur t’a eu.'; }
    const banner=$('personal-banner');
    banner.textContent=text;
    banner.className='result-banner '+(win?'result-win':'result-lose');

    const box=$('res-votes'); box.innerHTML=''; const ul=document.createElement('ul');
    for(const [tid,c] of Object.entries(res.votes)){
      const name=(room.players.find(p=>p.id===tid)||{}).name||tid;
      const li=document.createElement('li'); li.textContent=`${name} : ${c} vote(s)`; ul.appendChild(li);
    }
    box.appendChild(ul);

    $('btn-next').style.display='block';
    $('btn-next').disabled=false;
    $('btn-next').textContent='Manche suivante';

    const total=(room.players||[]).length||0;
    const pr=$('progress-ready'); if(pr) pr.textContent=`0/${total} prêts`;
    const tr=$('timer-reveal'); if(tr) tr.textContent='--:--';
  });

  /* Prêt entre manches */
  socket.on('readyProgress', ({ ready, total }) => {
    const el = document.getElementById('progress-ready');
    if (el) el.textContent = `${ready}/${total} prêts`;
  });

  /* Divers */
  socket.on('gameOver', ({ winners, autoReset })=>{
    const names=winners.map(w=>`${w.name} (${w.score})`).join(', ');
    $('winners-text').textContent = winners.length>1 ? `Égalité ! ${names}` : `${names} gagne la partie !`;
    $('modal').style.display='flex';
    show('screen-lobby');
    myLobbyReady = false;
    $('btn-ready').textContent = 'Je suis prêt';
    $('timer-lobby').style.display='none';
    if (autoReset) toast('Scores réinitialisés automatiquement');
  });
  socket.on('scoresReset', ()=>{ toast('Scores remis à 0'); show('screen-lobby'); });
  socket.on('actionAck', ({ action })=>{ if(action==='startRound') toast('Manche démarrée 🚀'); if(action==='nextRound') toast('Nouvelle manche ➡️'); });
  socket.on('errorMsg', (m)=>toast(m));

  /* Affichage initial */
  show('screen-home');


  // Leaderboard events
  if ($('btn-lb-refresh')) $('btn-lb-refresh').onclick = ()=> socket.emit('getLeaderboard');
   if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    });
    let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;                 // on garde l’événement
  document.getElementById('btn-install').style.display = 'inline-block';
});

document.getElementById('btn-install')?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;    // { outcome: 'accepted' | 'dismissed' }
  deferredPrompt = null;
  document.getElementById('btn-install').style.display = 'none';
});
  }
</script>
</body>
</html>
